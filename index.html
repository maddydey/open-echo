<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenEcho Media</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #1c1c1d);
            --text: var(--tg-theme-text-color, #ffffff);
            --button: var(--tg-theme-button-color, #0a84ff);
            --secondary: var(--tg-theme-secondary-bg-color, #2c2c2e);
            --hint: var(--tg-theme-hint-color, #8e8e93);
        }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 15px; padding-bottom: 100px; }
        .echo-card { background: var(--secondary); padding: 16px; border-radius: 16px; margin-bottom: 12px; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); }
        .author { font-weight: bold; color: var(--button); margin-bottom: 8px; font-size: 14px; }
        .post-img { width: 100%; border-radius: 10px; margin-top: 10px; display: block; }
        .content { font-size: 16px; line-height: 1.4; margin-top: 8px; }
        .delete-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); border: none; font-size: 16px; cursor: pointer; border-radius: 50%; width: 30px; height: 30px; color: white; }
        .btn-add { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; background: var(--button); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; }
        #fileInput { display: none; }
    </style>
</head>
<body>
    <h2>OpenEcho Media üöÄ</h2>
    <div id="feed"></div>
    
    <input type="file" id="fileInput" accept="image/*">
    <button class="btn-add" onclick="document.getElementById('fileInput').click()">+</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const SUPABASE_URL = 'https://xddulhzvzemmrhrsjfhb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const currentUserId = tg.initDataUnsafe?.user?.id?.toString();

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ª–µ–Ω—Ç—ã
        async function loadEchos() {
            const { data } = await supabaseClient.from('posts').select('*').order('created_at', { ascending: false });
            const feed = document.getElementById('feed');
            if (data) {
                feed.innerHTML = '';
                data.forEach(post => {
                    const isMyPost = post.user_id === currentUserId;
                    const imgTag = post.image_url ? `<img src="${post.image_url}" class="post-img">` : '';
                    const deleteBtn = isMyPost ? `<button class="delete-btn" onclick="deleteEcho('${post.id}')">üóëÔ∏è</button>` : '';

                    const card = document.createElement('div');
                    card.className = 'echo-card';
                    card.innerHTML = `
                        ${deleteBtn}
                        <div class="author">@${post.username || 'anon'}</div>
                        ${imgTag}
                        <div class="content">${post.content}</div>
                    `;
                    feed.appendChild(card);
                });
            }
        }

        // –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞
        document.getElementById('fileInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const text = prompt("–û–ø–∏—Å–∞–Ω–∏–µ –∫ —Ñ–æ—Ç–æ:");
            const user = tg.initDataUnsafe?.user?.username || "Guest";
            
            let imageUrl = null;

            // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –≤ Storage
            const fileName = `${Date.now()}_${file.name}`;
            const { data, error } = await supabaseClient.storage
                .from('images')
                .upload(fileName, file);

            if (data) {
                // –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ
                const { data: urlData } = supabaseClient.storage.from('images').getPublicUrl(fileName);
                imageUrl = urlData.publicUrl;
            }

            // 2. –°–æ–∑–¥–∞–µ–º –ø–æ—Å—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ
            await supabaseClient.from('posts').insert([{ 
                username: user, 
                content: text || "", 
                user_id: currentUserId,
                image_url: imageUrl
            }]);

            loadEchos();
        };

        async function deleteEcho(id) {
            if (confirm("–£–¥–∞–ª–∏—Ç—å?")) {
                await supabaseClient.from('posts').delete().eq('id', id);
                loadEchos();
            }
        }

        loadEchos();
    </script>
</body>
</html>
