<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenEcho One UI</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
font-family: -apple-system, sans-serif;
background: #f5f5f5;
padding: 16px;
padding-bottom: 80px;
}

h2 {
font-size: 24px;
margin-bottom: 20px;
}

.debug {
background: #333;
color: #0f0;
padding: 10px;
border-radius: 8px;
margin-bottom: 16px;
font-size: 11px;
font-family: monospace;
white-space: pre-wrap;
word-wrap: break-word;
}

#feed {
display: flex;
flex-direction: column;
gap: 12px;
}

.card {
background: white;
border-radius: 16px;
padding: 16px;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.author {
color: #007aff;
font-weight: 600;
font-size: 14px;
margin-bottom: 8px;
}

.text {
color: #333;
line-height: 1.4;
margin-bottom: 8px;
word-wrap: break-word;
}

.img {
width: 100%;
border-radius: 12px;
margin-bottom: 8px;
cursor: pointer;
}

.reply-box {
background: #f0f0f0;
border-left: 3px solid #007aff;
padding: 8px;
border-radius: 8px;
margin-bottom: 8px;
font-size: 13px;
}

.actions {
display: flex;
gap: 16px;
font-size: 13px;
margin-top: 8px;
}

.btn {
color: #007aff;
cursor: pointer;
font-weight: 500;
}

.btn-del {
color: #ff3b30;
}

.add-btn {
position: fixed;
bottom: 20px;
right: 20px;
width: 56px;
height: 56px;
background: #007aff;
color: white;
border: none;
border-radius: 50%;
font-size: 28px;
cursor: pointer;
box-shadow: 0 4px 12px rgba(0,122,255,0.4);
}

.modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.5);
z-index: 100;
}

.modal.show {
display: flex;
align-items: center;
justify-content: center;
padding: 20px;
}

.modal-content {
background: white;
border-radius: 16px;
padding: 20px;
width: 100%;
max-width: 400px;
}

textarea {
width: 100%;
border: 1px solid #ddd;
border-radius: 8px;
padding: 12px;
font-size: 15px;
font-family: inherit;
resize: none;
margin-bottom: 12px;
}

input[type=‚Äútext‚Äù] {
width: 100%;
border: 1px solid #ddd;
border-radius: 8px;
padding: 10px;
font-size: 14px;
margin-bottom: 12px;
}

.modal-btns {
display: flex;
justify-content: space-between;
align-items: center;
}

.send-btn {
background: #007aff;
color: white;
border: none;
padding: 10px 20px;
border-radius: 8px;
font-weight: 600;
cursor: pointer;
}

.send-btn:disabled {
opacity: 0.5;
}

.file-btn {
background: none;
border: none;
color: #007aff;
font-size: 14px;
cursor: pointer;
}

.preview {
width: 60px;
height: 60px;
position: relative;
margin-bottom: 12px;
}

.preview img {
width: 100%;
height: 100%;
border-radius: 8px;
object-fit: cover;
}

.preview-close {
position: absolute;
top: -8px;
right: -8px;
background: #ff3b30;
color: white;
border-radius: 50%;
width: 20px;
height: 20px;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
font-size: 12px;
}

.loading {
text-align: center;
padding: 20px;
color: #999;
}

.empty {
text-align: center;
padding: 60px 20px;
color: #999;
}

.error {
background: #ff3b30;
color: white;
padding: 12px;
border-radius: 8px;
margin: 20px 0;
text-align: center;
}

.overlay {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.9);
z-index: 200;
align-items: center;
justify-content: center;
}

.overlay.show {
display: flex;
}

.overlay img {
max-width: 90%;
max-height: 90%;
border-radius: 8px;
}
</style>

</head>
<body>
<h2>OpenEcho üî•</h2>

<div id="debug" class="debug">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>

<div id="feed">
  <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<button class="add-btn" onclick="openModal()">+</button>

<div id="modal" class="modal" onclick="if(event.target==this) closeModal()">
  <div class="modal-content">
    <div id="replyBox" style="display:none" class="reply-box">
      <div style="font-weight:600;color:#007aff;" id="replyAuthor"></div>
      <div style="color:#666;font-size:13px;" id="replyText"></div>
    </div>

```
<textarea id="txt" rows="4" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>

<div id="preview" class="preview" style="display:none">
  <img id="previewImg">
  <div class="preview-close" onclick="clearFile()">√ó</div>
</div>

<input type="text" id="target" placeholder="–ü—Ä–∏–≤–∞—Ç–Ω–æ –¥–ª—è @username (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">

<div class="modal-btns">
  <button class="file-btn" onclick="document.getElementById('file').click()">
    üì∑ –§–æ—Ç–æ
  </button>
  <input type="file" id="file" hidden accept="image/*" onchange="showPreview()">
  <button class="send-btn" id="sendBtn" onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>
```

  </div>
</div>

<div id="overlay" class="overlay" onclick="closeOverlay()">
  <img id="overlayImg">
</div>

<script>
// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
function log(msg) {
  console.log(msg);
  const debug = document.getElementById('debug');
  debug.textContent += '\n' + msg;
}

const tg = window.Telegram.WebApp;
log('‚úì Telegram WebApp –∑–∞–≥—Ä—É–∂–µ–Ω');
tg.expand();

// ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –î–ê–ù–ù–´–ï –ò–ó SUPABASE
const SUPABASE_URL = 'https://xddulhzvzemmrhrsjfhb.supabase.co';
const SUPABASE_KEY = 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j';

log('–ü—Ä–æ–≤–µ—Ä–∫–∞ Supabase URL: ' + SUPABASE_URL);

let db = null;
let userId = null;
let username = null;
let replyId = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
async function init() {
  try {
    log('–ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram
    const user = tg.initDataUnsafe?.user;
    log('Telegram user: ' + JSON.stringify(user));
    
    if (!user) {
      log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ');
      // –î–ª—è —Ç–µ—Å—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
      userId = 'test123';
      username = 'TestUser';
    } else {
      userId = user.id.toString();
      username = user.username || 'User' + user.id;
    }
    
    log('‚úì User ID: ' + userId);
    log('‚úì Username: ' + username);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ Supabase
    if (SUPABASE_URL.includes('your-project') || SUPABASE_KEY.includes('your-anon')) {
      throw new Error('‚ö†Ô∏è –ù–µ —É–∫–∞–∑–∞–Ω—ã SUPABASE_URL –∏ SUPABASE_KEY!');
    }
    
    log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase...');
    db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    log('‚úì Supabase –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î...');
    const { data: testData, error: testError } = await db
      .from('posts')
      .select('count')
      .limit(1);
    
    if (testError) {
      log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + testError.message);
      throw testError;
    }
    
    log('‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å–ø–µ—à–Ω–æ');
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
    await load();
    
    // Realtime –ø–æ–¥–ø–∏—Å–∫–∞
    log('–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ realtime –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...');
    db.channel('posts-channel')
      .on('postgres_changes', { 
        event: '*', 
        schema: 'public', 
        table: 'posts' 
      }, (payload) => {
        log('üì° Realtime: ' + payload.eventType);
        load();
      })
      .subscribe((status) => {
        log('Realtime status: ' + status);
      });
    
    log('‚úì –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
    
  } catch (e) {
    log('‚ùå –û–®–ò–ë–ö–ê: ' + e.message);
    console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', e);
    document.getElementById('feed').innerHTML = 
      '<div class="error">–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message + '</div>';
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
async function load() {
  try {
    log('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...');
    
    const { data, error } = await db
      .from('posts')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(30);
    
    if (error) {
      log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
      throw error;
    }
    
    log('‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ—Å—Ç–æ–≤: ' + (data ? data.length : 0));
    
    const feed = document.getElementById('feed');
    
    if (!data || data.length === 0) {
      feed.innerHTML = '<div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤<br>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º! üìù</div>';
      return;
    }
    
    feed.innerHTML = '';
    
    data.forEach(post => {
      const isMy = post.user_id === userId;
      const isForMe = post.target_username === username;
      
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —á—É–∂–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ
      if (post.target_username && !isMy && !isForMe) return;
      
      const card = document.createElement('div');
      card.className = 'card';
      
      let html = '';
      
      // –û—Ç–≤–µ—Ç
      if (post.parent_id) {
        const parent = data.find(p => p.id === post.parent_id);
        if (parent) {
          html += `<div class="reply-box">
            <div style="font-weight:600;color:#007aff;">@${esc(parent.username)}</div>
            <div style="color:#666;">${esc(parent.content || 'üì∑ –§–æ—Ç–æ')}</div>
          </div>`;
        }
      }
      
      // –ê–≤—Ç–æ—Ä
      const lock = post.target_username ? ' üîí' : '';
      html += `<div class="author">@${esc(post.username)}${lock}</div>`;
      
      // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      if (post.image_url) {
        html += `<img class="img" src="${post.image_url}" onclick="showImage('${post.image_url}')">`;
      }
      
      // –¢–µ–∫—Å—Ç
      if (post.content) {
        html += `<div class="text">${esc(post.content)}</div>`;
      }
      
      // –î–µ–π—Å—Ç–≤–∏—è
      html += `<div class="actions">
        <span class="btn" onclick="reply('${post.id}', '${esc(post.username)}', '${esc((post.content || '').substring(0, 40))}')">
          –û—Ç–≤–µ—Ç–∏—Ç—å
        </span>`;
      
      if (isMy) {
        html += `<span class="btn btn-del" onclick="del('${post.id}')">–£–¥–∞–ª–∏—Ç—å</span>`;
      }
      
      html += '</div>';
      
      card.innerHTML = html;
      feed.appendChild(card);
    });
    
  } catch (e) {
    log('‚ùå –û—à–∏–±–∫–∞ load(): ' + e.message);
    console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', e);
    document.getElementById('feed').innerHTML = 
      '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message + '</div>';
  }
}

function esc(str) {
  const div = document.createElement('div');
  div.textContent = str || '';
  return div.innerHTML;
}

// –ú–æ–¥–∞–ª–∫–∞
function openModal() {
  document.getElementById('modal').classList.add('show');
}

function closeModal() {
  document.getElementById('modal').classList.remove('show');
  document.getElementById('txt').value = '';
  document.getElementById('target').value = '';
  document.getElementById('replyBox').style.display = 'none';
  clearFile();
  replyId = null;
}

function reply(id, user, text) {
  replyId = id;
  document.getElementById('replyAuthor').textContent = '@' + user;
  document.getElementById('replyText').textContent = text + '...';
  document.getElementById('replyBox').style.display = 'block';
  openModal();
}

// –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ
function showPreview() {
  const file = document.getElementById('file').files[0];
  if (!file) return;
  
  if (file.size > 5 * 1024 * 1024) {
    alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 5–ú–ë)');
    document.getElementById('file').value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('previewImg').src = e.target.result;
    document.getElementById('preview').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

function clearFile() {
  document.getElementById('file').value = '';
  document.getElementById('preview').style.display = 'none';
}

// –û—Ç–ø—Ä–∞–≤–∫–∞
async function send() {
  const btn = document.getElementById('sendBtn');
  const text = document.getElementById('txt').value.trim();
  const targetUser = document.getElementById('target').value.replace('@', '').trim();
  const file = document.getElementById('file').files[0];
  
  if (!text && !file) {
    alert('–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ');
    return;
  }
  
  btn.disabled = true;
  btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
  log('–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å—Ç–∞...');
  
  try {
    let imageUrl = null;
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ
    if (file) {
      log('–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');
      const fileName = Date.now() + '.jpg';
      const { data: upData, error: upError } = await db.storage
        .from('images')
        .upload(fileName, file);
      
      if (upError) {
        log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: ' + upError.message);
        throw upError;
      }
      
      const { data: { publicUrl } } = db.storage
        .from('images')
        .getPublicUrl(fileName);
      
      imageUrl = publicUrl;
      log('‚úì –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ' + imageUrl);
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞
    log('–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ –≤ –ë–î...');
    const postData = {
      username: username,
      content: text,
      user_id: userId,
      image_url: imageUrl,
      target_username: targetUser || null,
      parent_id: replyId
    };
    
    log('–î–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞: ' + JSON.stringify(postData));
    
    const { data: insertData, error } = await db
      .from('posts')
      .insert([postData])
      .select();
    
    if (error) {
      log('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞: ' + error.message);
      throw error;
    }
    
    log('‚úì –ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω: ' + JSON.stringify(insertData));
    
    closeModal();
    await load();
    
  } catch (e) {
    log('‚ùå –û—à–∏–±–∫–∞ send(): ' + e.message);
    console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', e);
    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
  }
}

// –£–¥–∞–ª–µ–Ω–∏–µ
async function del(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?')) return;
  
  log('–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ ' + id);
  
  try {
    const { error } = await db
      .from('posts')
      .delete()
      .eq('id', id)
      .eq('user_id', userId);
    
    if (error) {
      log('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
      throw error;
    }
    
    log('‚úì –ü–æ—Å—Ç —É–¥–∞–ª—ë–Ω');
    await load();
    
  } catch (e) {
    log('‚ùå –û—à–∏–±–∫–∞ del(): ' + e.message);
    console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', e);
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + e.message);
  }
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ
function showImage(url) {
  document.getElementById('overlayImg').src = url;
  document.getElementById('overlay').classList.add('show');
}

function closeOverlay() {
  document.getElementById('overlay').classList.remove('show');
}

// –°—Ç–∞—Ä—Ç
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>

</body>
</html>
