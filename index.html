<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenEcho One UI</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #f5f5f5;
  --card-bg: rgba(255, 255, 255, 0.7);
  --text: #1a1a1a;
  --text-dim: #666;
  --accent: #1b6ef3;
  --border: rgba(0, 0, 0, 0.08);
  --shadow: rgba(0, 0, 0, 0.1);
}

[data-theme=‚Äúdark‚Äù] {
‚Äìbg: #0a0a0a;
‚Äìcard-bg: rgba(30, 30, 30, 0.7);
‚Äìtext: #e5e5e5;
‚Äìtext-dim: #999;
‚Äìaccent: #5093ff;
‚Äìborder: rgba(255, 255, 255, 0.1);
‚Äìshadow: rgba(0, 0, 0, 0.5);
}

- {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  }

body {
font-family: ‚ÄòSF Pro Display‚Äô, -apple-system, sans-serif;
background: var(‚Äìbg);
color: var(‚Äìtext);
padding: 20px;
padding-bottom: 100px;
transition: background 0.4s ease, color 0.4s ease;
}

.header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 24px;
}

h2 {
font-size: 28px;
font-weight: 700;
letter-spacing: -0.5px;
}

.theme-toggle {
width: 44px;
height: 44px;
border-radius: 50%;
background: var(‚Äìcard-bg);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
border: 1px solid var(‚Äìborder);
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
font-size: 20px;
transition: all 0.3s ease;
box-shadow: 0 4px 12px var(‚Äìshadow);
}

.theme-toggle:active {
transform: scale(0.9);
}

#feed {
display: flex;
flex-direction: column;
gap: 16px;
}

.card {
background: var(‚Äìcard-bg);
backdrop-filter: blur(40px);
-webkit-backdrop-filter: blur(40px);
border-radius: 24px;
padding: 20px;
border: 1px solid var(‚Äìborder);
box-shadow: 0 8px 32px var(‚Äìshadow);
opacity: 0;
transform: translateY(20px);
animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

@keyframes slideUp {
to {
opacity: 1;
transform: translateY(0);
}
}

.card:nth-child(2) { animation-delay: 0.05s; }
.card:nth-child(3) { animation-delay: 0.1s; }
.card:nth-child(4) { animation-delay: 0.15s; }

.author {
color: var(‚Äìaccent);
font-weight: 600;
font-size: 15px;
margin-bottom: 10px;
display: flex;
align-items: center;
gap: 6px;
}

.text {
color: var(‚Äìtext);
line-height: 1.5;
margin-bottom: 12px;
word-wrap: break-word;
font-size: 15px;
}

.img {
width: 100%;
border-radius: 16px;
margin-bottom: 12px;
cursor: pointer;
transition: transform 0.3s ease, filter 0.3s ease;
}

.img:active {
transform: scale(0.98);
filter: brightness(0.9);
}

.reply-box {
background: var(‚Äìcard-bg);
backdrop-filter: blur(20px);
border-left: 3px solid var(‚Äìaccent);
padding: 10px 12px;
border-radius: 12px;
margin-bottom: 12px;
font-size: 13px;
border: 1px solid var(‚Äìborder);
}

.reply-author {
font-weight: 600;
color: var(‚Äìaccent);
margin-bottom: 4px;
}

.reply-text {
color: var(‚Äìtext-dim);
font-size: 13px;
}

.link-preview {
background: var(‚Äìcard-bg);
backdrop-filter: blur(20px);
border: 1px solid var(‚Äìborder);
border-radius: 16px;
overflow: hidden;
margin-top: 12px;
cursor: pointer;
transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
box-shadow: 0 4px 16px var(‚Äìshadow);
}

.link-preview:active {
transform: scale(0.98);
box-shadow: 0 2px 8px var(‚Äìshadow);
}

.link-preview-img {
width: 100%;
height: 180px;
object-fit: cover;
background: linear-gradient(135deg, var(‚Äìaccent) 0%, #9055ff 100%);
}

.link-preview-content {
padding: 14px;
}

.link-preview-title {
font-weight: 600;
font-size: 15px;
color: var(‚Äìtext);
margin-bottom: 6px;
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
}

.link-preview-desc {
font-size: 13px;
color: var(‚Äìtext-dim);
line-height: 1.4;
overflow: hidden;
display: -webkit-box;
-webkit-line-clamp: 2;
-webkit-box-orient: vertical;
margin-bottom: 8px;
}

.link-preview-url {
font-size: 12px;
color: var(‚Äìaccent);
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
}

.actions {
display: flex;
gap: 20px;
font-size: 14px;
margin-top: 12px;
padding-top: 12px;
border-top: 1px solid var(‚Äìborder);
}

.btn {
color: var(‚Äìaccent);
cursor: pointer;
font-weight: 500;
transition: all 0.2s ease;
display: flex;
align-items: center;
gap: 4px;
}

.btn:active {
transform: scale(0.95);
opacity: 0.7;
}

.btn-del {
color: #ff3b30;
}

.add-btn {
position: fixed;
bottom: 24px;
right: 24px;
width: 60px;
height: 60px;
background: linear-gradient(135deg, var(‚Äìaccent) 0%, #9055ff 100%);
color: white;
border: none;
border-radius: 50%;
font-size: 28px;
cursor: pointer;
box-shadow: 0 8px 24px rgba(27, 110, 243, 0.4);
z-index: 100;
transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
backdrop-filter: blur(20px);
}

.add-btn:active {
transform: scale(0.9) rotate(90deg);
}

.modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.6);
backdrop-filter: blur(10px);
-webkit-backdrop-filter: blur(10px);
z-index: 200;
opacity: 0;
transition: opacity 0.3s ease;
}

.modal.show {
display: flex;
align-items: center;
justify-content: center;
padding: 20px;
opacity: 1;
}

.modal-content {
background: var(‚Äìcard-bg);
backdrop-filter: blur(40px);
-webkit-backdrop-filter: blur(40px);
border-radius: 24px;
padding: 24px;
width: 100%;
max-width: 420px;
border: 1px solid var(‚Äìborder);
box-shadow: 0 20px 60px var(‚Äìshadow);
transform: scale(0.9) translateY(20px);
transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.modal.show .modal-content {
transform: scale(1) translateY(0);
}

textarea {
width: 100%;
border: 1px solid var(‚Äìborder);
border-radius: 16px;
padding: 14px;
font-size: 15px;
font-family: inherit;
resize: none;
margin-bottom: 12px;
background: var(‚Äìcard-bg);
backdrop-filter: blur(20px);
color: var(‚Äìtext);
transition: all 0.2s ease;
}

textarea:focus {
outline: none;
border-color: var(‚Äìaccent);
box-shadow: 0 0 0 3px rgba(27, 110, 243, 0.1);
}

input[type=‚Äútext‚Äù] {
width: 100%;
border: 1px solid var(‚Äìborder);
border-radius: 16px;
padding: 12px 14px;
font-size: 14px;
margin-bottom: 16px;
background: var(‚Äìcard-bg);
backdrop-filter: blur(20px);
color: var(‚Äìtext);
transition: all 0.2s ease;
}

input[type=‚Äútext‚Äù]:focus {
outline: none;
border-color: var(‚Äìaccent);
box-shadow: 0 0 0 3px rgba(27, 110, 243, 0.1);
}

.modal-btns {
display: flex;
justify-content: space-between;
align-items: center;
gap: 12px;
}

.send-btn {
background: linear-gradient(135deg, var(‚Äìaccent) 0%, #9055ff 100%);
color: white;
border: none;
padding: 12px 28px;
border-radius: 16px;
font-weight: 600;
font-size: 15px;
cursor: pointer;
transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
box-shadow: 0 4px 16px rgba(27, 110, 243, 0.3);
}

.send-btn:active {
transform: scale(0.95);
box-shadow: 0 2px 8px rgba(27, 110, 243, 0.3);
}

.send-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

.file-btn {
background: var(‚Äìcard-bg);
backdrop-filter: blur(20px);
border: 1px solid var(‚Äìborder);
color: var(‚Äìtext);
font-size: 14px;
cursor: pointer;
padding: 12px 20px;
border-radius: 16px;
font-weight: 500;
transition: all 0.2s ease;
}

.file-btn:active {
transform: scale(0.95);
}

.preview {
width: 80px;
height: 80px;
position: relative;
margin-bottom: 12px;
border-radius: 12px;
overflow: hidden;
}

.preview img {
width: 100%;
height: 100%;
object-fit: cover;
}

.preview-close {
position: absolute;
top: -8px;
right: -8px;
background: #ff3b30;
color: white;
border-radius: 50%;
width: 24px;
height: 24px;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
font-size: 14px;
font-weight: 600;
box-shadow: 0 2px 8px rgba(255, 59, 48, 0.4);
transition: transform 0.2s ease;
}

.preview-close:active {
transform: scale(0.9);
}

.loading {
text-align: center;
padding: 40px 20px;
color: var(‚Äìtext-dim);
font-size: 15px;
}

.empty {
text-align: center;
padding: 80px 20px;
color: var(‚Äìtext-dim);
}

.empty-icon {
font-size: 64px;
margin-bottom: 16px;
opacity: 0.5;
}

.error {
background: linear-gradient(135deg, #ff3b30 0%, #ff6b6b 100%);
color: white;
padding: 16px;
border-radius: 16px;
margin: 20px 0;
text-align: center;
box-shadow: 0 8px 24px rgba(255, 59, 48, 0.3);
}

.overlay {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.95);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
z-index: 300;
align-items: center;
justify-content: center;
opacity: 0;
transition: opacity 0.3s ease;
}

.overlay.show {
display: flex;
opacity: 1;
}

.overlay img {
max-width: 90%;
max-height: 90%;
border-radius: 16px;
box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
transform: scale(0.9);
transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.overlay.show img {
transform: scale(1);
}

@media (prefers-reduced-motion: reduce) {

- {
  animation: none !important;
  transition: none !important;
  }
  }

</style>
</head>
<body data-theme="light">

<div class="header">
  <h2>OpenEcho üî•</h2>
  <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
</div>

<div id="feed">
  <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<button class="add-btn" onclick="openModal()">+</button>

<div id="modal" class="modal" onclick="if(event.target==this) closeModal()">
  <div class="modal-content">
    <div id="replyBox" style="display:none" class="reply-box">
      <div class="reply-author" id="replyAuthor"></div>
      <div class="reply-text" id="replyText"></div>
    </div>

```
<textarea id="txt" rows="4" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>

<div id="preview" class="preview" style="display:none">
  <img id="previewImg">
  <div class="preview-close" onclick="clearFile()">√ó</div>
</div>

<input type="text" id="target" placeholder="–ü—Ä–∏–≤–∞—Ç–Ω–æ –¥–ª—è @username (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">

<div class="modal-btns">
  <button class="file-btn" onclick="document.getElementById('file').click()">
    üì∑ –§–æ—Ç–æ
  </button>
  <input type="file" id="file" hidden accept="image/*" onchange="showPreview()">
  <button class="send-btn" id="sendBtn" onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>
```

  </div>
</div>

<div id="overlay" class="overlay" onclick="closeOverlay()">
  <img id="overlayImg">
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

// ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –î–ê–ù–ù–´–ï –ò–ó SUPABASE
const SUPABASE_URL = 'https://xddulhzvzemmrhrsjfhb.supabase.co';
const SUPABASE_KEY = 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j';

let db = null;
let userId = null;
let username = null;
let replyId = null;

// –¢–µ–º–∞
function toggleTheme() {
  const body = document.body;
  const btn = document.querySelector('.theme-toggle');
  const currentTheme = body.getAttribute('data-theme');
  
  if (currentTheme === 'light') {
    body.setAttribute('data-theme', 'dark');
    btn.textContent = '‚òÄÔ∏è';
    localStorage.setItem('theme', 'dark');
  } else {
    body.setAttribute('data-theme', 'light');
    btn.textContent = 'üåô';
    localStorage.setItem('theme', 'light');
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã
const savedTheme = localStorage.getItem('theme') || 'light';
document.body.setAttribute('data-theme', savedTheme);
if (savedTheme === 'dark') {
  document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
async function init() {
  try {
    const user = tg.initDataUnsafe?.user;
    
    if (!user) {
      userId = 'test123';
      username = 'TestUser';
    } else {
      userId = user.id.toString();
      username = user.username || 'User' + user.id;
    }
    
    if (SUPABASE_URL.includes('your-project') || SUPABASE_KEY.includes('your-anon')) {
      throw new Error('–ù–µ —É–∫–∞–∑–∞–Ω—ã SUPABASE_URL –∏ SUPABASE_KEY');
    }
    
    db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    await load();
    
    db.channel('posts-channel')
      .on('postgres_changes', { 
        event: '*', 
        schema: 'public', 
        table: 'posts' 
      }, () => load())
      .subscribe();
    
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞:', e);
    document.getElementById('feed').innerHTML = 
      '<div class="error">–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message + '</div>';
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
async function load() {
  try {
    const { data, error } = await db
      .from('posts')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(30);
    
    if (error) throw error;
    
    const feed = document.getElementById('feed');
    
    if (!data || data.length === 0) {
      feed.innerHTML = `
        <div class="empty">
          <div class="empty-icon">üìù</div>
          <div>–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤<br>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>
        </div>`;
      return;
    }
    
    feed.innerHTML = '';
    
    data.forEach(post => {
      const isMy = post.user_id === userId;
      const isForMe = post.target_username === username;
      
      if (post.target_username && !isMy && !isForMe) return;
      
      const card = document.createElement('div');
      card.className = 'card';
      
      let html = '';
      
      // –û—Ç–≤–µ—Ç
      if (post.parent_id) {
        const parent = data.find(p => p.id === post.parent_id);
        if (parent) {
          html += `<div class="reply-box">
            <div class="reply-author">@${esc(parent.username)}</div>
            <div class="reply-text">${esc(parent.content || 'üì∑ –§–æ—Ç–æ')}</div>
          </div>`;
        }
      }
      
      // –ê–≤—Ç–æ—Ä
      const lock = post.target_username ? ' üîí' : '';
      html += `<div class="author">@${esc(post.username)}${lock}</div>`;
      
      // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      if (post.image_url) {
        html += `<img class="img" src="${post.image_url}" onclick="showImage('${post.image_url}')" loading="lazy">`;
      }
      
      // –¢–µ–∫—Å—Ç —Å —Å—Å—ã–ª–∫–∞–º–∏
      if (post.content) {
        const { text, links } = extractLinks(post.content);
        html += `<div class="text">${esc(text)}</div>`;
        
        // –ü—Ä–µ–≤—å—é —Å—Å—ã–ª–æ–∫
        if (links.length > 0 && post.link_preview) {
          try {
            const preview = JSON.parse(post.link_preview);
            html += `
              <div class="link-preview" onclick="window.open('${preview.url}', '_blank')">
                ${preview.image ? `<img class="link-preview-img" src="${preview.image}" onerror="this.style.display='none'" loading="lazy">` : ''}
                <div class="link-preview-content">
                  <div class="link-preview-title">${esc(preview.title || '–°—Å—ã–ª–∫–∞')}</div>
                  ${preview.description ? `<div class="link-preview-desc">${esc(preview.description)}</div>` : ''}
                  <div class="link-preview-url">${esc(preview.domain || preview.url)}</div>
                </div>
              </div>`;
          } catch (e) {}
        }
      }
      
      // –î–µ–π—Å—Ç–≤–∏—è
      html += `<div class="actions">
        <span class="btn" onclick="reply('${post.id}', '${esc(post.username)}', '${esc((post.content || '').substring(0, 40))}')">
          üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å
        </span>`;
      
      if (isMy) {
        html += `<span class="btn btn-del" onclick="del('${post.id}')">üóë –£–¥–∞–ª–∏—Ç—å</span>`;
      }
      
      html += '</div>';
      
      card.innerHTML = html;
      feed.appendChild(card);
    });
    
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞:', e);
    document.getElementById('feed').innerHTML = 
      '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤</div>';
  }
}

function esc(str) {
  const div = document.createElement('div');
  div.textContent = str || '';
  return div.innerHTML;
}

function extractLinks(text) {
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  const links = text.match(urlRegex) || [];
  return { text, links };
}

async function fetchLinkPreview(url) {
  try {
    const apiUrl = `https://api.microlink.io/?url=${encodeURIComponent(url)}`;
    const response = await fetch(apiUrl);
    const data = await response.json();
    
    if (data.status === 'success') {
      return {
        url: url,
        title: data.data.title || '',
        description: data.data.description || '',
        image: data.data.image?.url || data.data.logo?.url || '',
        domain: new URL(url).hostname
      };
    }
    return null;
  } catch (e) {
    return null;
  }
}

function openModal() {
  document.getElementById('modal').classList.add('show');
}

function closeModal() {
  document.getElementById('modal').classList.remove('show');
  setTimeout(() => {
    document.getElementById('txt').value = '';
    document.getElementById('target').value = '';
    document.getElementById('replyBox').style.display = 'none';
    clearFile();
    replyId = null;
  }, 300);
}

function reply(id, user, text) {
  replyId = id;
  document.getElementById('replyAuthor').textContent = '@' + user;
  document.getElementById('replyText').textContent = text + '...';
  document.getElementById('replyBox').style.display = 'block';
  openModal();
}

function showPreview() {
  const file = document.getElementById('file').files[0];
  if (!file) return;
  
  if (file.size > 5 * 1024 * 1024) {
    tg.showAlert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 5–ú–ë)');
    document.getElementById('file').value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('previewImg').src = e.target.result;
    document.getElementById('preview').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

function clearFile() {
  document.getElementById('file').value = '';
  document.getElementById('preview').style.display = 'none';
}

async function send() {
  const btn = document.getElementById('sendBtn');
  const text = document.getElementById('txt').value.trim();
  const targetUser = document.getElementById('target').value.replace('@', '').trim();
  const file = document.getElementById('file').files[0];
  
  if (!text && !file) {
    tg.showAlert('–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ');
    return;
  }
  
  btn.disabled = true;
  btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
  
  try {
    let imageUrl = null;
    
    if (file) {
      const fileName = Date.now() + '.jpg';
      const { data: upData, error: upError } = await db.storage
        .from('images')
        .upload(fileName, file);
      
      if (upError) throw upError;
      
      const { data: { publicUrl } } = db.storage
        .from('images')
        .getPublicUrl(fileName);
      
      imageUrl = publicUrl;
    }
    
    let linkPreview = null;
    const { links } = extractLinks(text);
    if (links.length > 0) {
      btn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—å—é...';
      linkPreview = await fetchLinkPreview(links[0]);
    }
    
    const postData = {
      username: username,
      content: text,
      user_id: userId,
      image_url: imageUrl,
      target_username: targetUser || null,
      parent_id: replyId,
      link_preview: linkPreview ? JSON.stringify(linkPreview) : null
    };
    
    const { error } = await db
      .from('posts')
      .insert([postData])
      .select();
    
    if (error) throw error;
    
    closeModal();
    await load();
    
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞:', e);
    tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
  }
}

async function del(id) {
  tg.showConfirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?', async (ok) => {
    if (!ok) return;
    
    try {
      const { error } = await db
        .from('posts')
        .delete()
        .eq('id', id)
        .eq('user_id', userId);
      
      if (error) throw error;
      
      await load();
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞:', e);
      tg.showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
    }
  });
}

function showImage(url) {
  document.getElementById('overlayImg').src = url;
  document.getElementById('overlay').classList.add('show');
}

function closeOverlay() {
  document.getElementById('overlay').classList.remove('show');
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>

</body>
</html>
