<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>OpenEcho TG Style</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* --- –¢–ï–ú–ê TELEGRAM DARK --- */
:root {
    --tg-bg: #18181a;          /* –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω (–≥–ª—É–±–æ–∫–∏–π —á–µ—Ä–Ω—ã–π) */
    --tg-card: #262628;        /* –§–æ–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ (—á—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ) */
    --tg-blue: #50a8eb;        /* –§–∏—Ä–º–µ–Ω–Ω—ã–π —Å–∏–Ω–∏–π */
    --tg-text: #ffffff;        /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
    --tg-hint: #8e8e93;        /* –°–µ—Ä—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
    --tg-border: rgba(255,255,255,0.08); /* –¢–æ–Ω–∫–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ */
    --tg-radius: 22px;         /* –†–∞–¥–∏—É—Å —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è */
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--tg-bg); color: var(--tg-text);
    padding: 16px; padding-bottom: 100px;
    overflow-x: hidden;
}

/* --- –õ–ï–ù–¢–ê –ò –ê–ù–ò–ú–ê–¶–ò–ò --- */
#feed { display: flex; flex-direction: column; gap: 24px; }

/* –ë–∞–∑–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
@keyframes slideUpFade {
    from { opacity: 0; transform: translateY(30px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}
.animate-in { animation: slideUpFade 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }

/* --- –ö–ê–†–¢–û–ß–ö–ò –ü–û–°–¢–û–í --- */
.post-container { display: flex; flex-direction: column; }

.main-post {
    background: var(--tg-card); border-radius: var(--tg-radius);
    padding: 18px; position: relative;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* –®–∞–ø–∫–∞ –ø–æ—Å—Ç–∞ (–ê–≤–∞—Ç–∞—Ä + –ò–º—è) */
.post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.avatar {
    width: 42px; height: 42px; border-radius: 50%;
    background: linear-gradient(135deg, var(--tg-blue), #7b61ff);
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 18px; color: white; text-transform: uppercase;
}
.username { font-weight: 600; font-size: 16px; color: var(--tg-text); }
.username span { color: var(--tg-blue); margin-left: 6px; font-size: 14px; } /* –ú–µ—Ç–∫–∞ PRIVATE */

/* –ö–æ–Ω—Ç–µ–Ω—Ç */
.post-text { font-size: 16px; line-height: 1.5; color: #e4e4e4; white-space: pre-wrap; }
.post-img { 
    width: calc(100% + 36px); margin: -18px -18px 16px -18px; 
    border-radius: var(--tg-radius) var(--tg-radius) 0 0; 
    max-height: 350px; object-fit: cover; display: block;
}

/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
.post-actions { 
    display: flex; gap: 20px; margin-top: 16px; padding-top: 16px; 
    border-top: 1px solid var(--tg-border); font-size: 14px; font-weight: 600; 
}
.action-btn { color: var(--tg-blue); cursor: pointer; transition: transform 0.1s; display: flex; align-items: center; gap: 6px;}
.action-btn:active { transform: scale(0.95); opacity: 0.8; } /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä—É–∂–∏–Ω—ã */

/* --- –í–ï–¢–ö–ê –û–¢–í–ï–¢–û–í (THREADS) --- */
.replies-thread {
    margin-top: 12px;
    margin-left: 24px; /* –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ */
    padding-left: 16px;
    border-left: 2px solid var(--tg-border); /* –õ–∏–Ω–∏—è —Å–≤—è–∑–∏ */
    display: flex; flex-direction: column; gap: 12px;
}

.reply-post {
    background: var(--tg-card); border-radius: 18px; padding: 14px;
    position: relative;
}
/* –ú–∞–ª–µ–Ω—å–∫–∞—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É */
.reply-post::before {
    content: ''; position: absolute; left: -18px; top: 24px;
    width: 16px; height: 2px; background: var(--tg-border);
}
.reply-post .avatar { width: 34px; height: 34px; font-size: 14px; }
.reply-post .username { font-size: 14px; }
.reply-post .post-text { font-size: 14px; }
.reply-post .post-img { width: calc(100% + 28px); margin: -14px -14px 12px -14px; border-radius: 18px 18px 0 0; max-height: 200px;}


/* --- –ü–õ–ê–í–ê–Æ–©–ê–Ø –ö–ù–û–ü–ö–ê (FAB) --- */
.fab {
    position: fixed; bottom: 30px; right: 24px;
    width: 64px; height: 64px; border-radius: 50%;
    background: var(--tg-blue); color: white;
    border: none; font-size: 32px; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 8px 20px rgba(80, 168, 235, 0.4);
    transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); /* –ü—Ä—É–∂–∏–Ω–∞ */
    z-index: 100;
}
.fab:active { transform: scale(0.9) rotate(10deg); }

/* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (–®–¢–û–†–ö–ê) --- */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); z-index: 1000;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
    display: flex; align-items: flex-end; /* –í—ã–µ–∑–∂–∞–µ—Ç —Å–Ω–∏–∑—É */
}
.modal-overlay.active { opacity: 1; pointer-events: auto; }

.modal-sheet {
    background: var(--tg-card); width: 100%;
    border-radius: 28px 28px 0 0; padding: 24px;
    transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.modal-overlay.active .modal-sheet { transform: translateY(0); }

.sheet-header { font-weight: 700; font-size: 20px; margin-bottom: 16px; text-align: center; }

/* –û–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ */
#replyContext {
    background: rgba(80, 168, 235, 0.1); border-left: 4px solid var(--tg-blue);
    padding: 10px 14px; border-radius: 12px; margin-bottom: 16px; display: none;
}
.reply-to-user { color: var(--tg-blue); font-weight: 700; font-size: 13px; margin-bottom: 4px; }
.reply-to-text { color: var(--tg-hint); font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

textarea {
    width: 100%; background: var(--tg-bg); border: none; border-radius: 16px;
    padding: 14px; color: var(--tg-text); font-size: 16px; resize: none; min-height: 120px; outline: none;
}
.input-row { display: flex; align-items: center; justify-content: space-between; margin-top: 20px; }
.attach-btn { color: var(--tg-blue); font-weight: 600; font-size: 15px; background: none; border: none; padding: 8px; }
.send-btn {
    background: var(--tg-blue); color: white; border: none;
    padding: 12px 28px; border-radius: 16px; font-weight: 700; font-size: 16px;
    transition: transform 0.1s;
}
.send-btn:active { transform: scale(0.96); }

/* –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ */
#mediaPreview { display: none; margin: 10px 0; position: relative; width: 80px; height: 80px; }
#previewImg { width: 100%; height: 100%; object-fit: cover; border-radius: 16px; }
.close-media { position: absolute; top: -8px; right: -8px; background: #ff3b30; color: white; border-radius: 50%; width: 24px; height: 24px; text-align: center; line-height: 24px; font-weight: bold; }
</style>
</head>
<body>

    <div id="feed"></div>

    <button class="fab" onclick="openSheet()">Ôºã</button>

    <div class="modal-overlay" id="modalOverlay" onclick="if(event.target==this) closeSheet()">
        <div class="modal-sheet">
            <div class="sheet-header">–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
            
            <div id="replyContext">
                <div class="reply-to-user" id="replyAuthor"></div>
                <div class="reply-to-text" id="replyText"></div>
            </div>
            
            <div id="mediaPreview">
                <img id="previewImg">
                <div class="close-media" onclick="clearFile()">‚úï</div>
            </div>

            <textarea id="postText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..."></textarea>
            
            <div class="input-row">
                <button class="attach-btn action-btn" onclick="document.getElementById('fileInput').click()">üì∑ –§–æ—Ç–æ</button>
                <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile()">
                <button class="send-btn" id="sendBtn" onclick="sendPost()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

<script>
// --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
const tg = window.Telegram.WebApp;
tg.expand();
// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞ –ø–æ–¥ —Ç–µ–º—É Telegram (–ø–æ –∂–µ–ª–∞–Ω–∏—é –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å)
// tg.setHeaderColor(tg.themeParams.bg_color || '#18181a');
// tg.setBackgroundColor(tg.themeParams.bg_color || '#18181a');

const SUPABASE_URL = 'https://xddulhzvzemmrhrsjfhb.supabase.co';
const SUPABASE_KEY = 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
const myUser = tg.initDataUnsafe?.user || { id: 'test_id', username: 'Tester', first_name: 'Test' };
const myUsername = myUser.username || myUser.first_name || 'Anon';
const myId = myUser.id.toString();

let currentReplyId = null;

// --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
function openSheet(replyToId = null, author = null, text = null) {
    if (replyToId) {
        currentReplyId = replyToId;
        document.getElementById('replyAuthor').textContent = '–û—Ç–≤–µ—Ç –¥–ª—è @' + author;
        document.getElementById('replyText').textContent = text;
        document.getElementById('replyContext').style.display = 'block';
        document.querySelector('.sheet-header').textContent = '–û—Ç–≤–µ—Ç –Ω–∞ –ø–æ—Å—Ç';
    } else {
        document.querySelector('.sheet-header').textContent = '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
    }
    document.getElementById('modalOverlay').classList.add('active');
    // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
    if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
}

function closeSheet() {
    document.getElementById('modalOverlay').classList.remove('active');
    setTimeout(() => {
        currentReplyId = null;
        document.getElementById('replyContext').style.display = 'none';
        document.getElementById('postText').value = '';
        clearFile();
    }, 300);
}

function handleFile() {
    const file = document.getElementById('fileInput').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('mediaPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

function clearFile() {
    document.getElementById('fileInput').value = '';
    document.getElementById('mediaPreview').style.display = 'none';
}

// --- –†–ï–ù–î–ï–†–ò–ù–ì –õ–ï–ù–¢–´ ---
function renderPostHTML(post, isReply = false) {
    const avatarLetter = (post.username || '?')[0].toUpperCase();
    const replyAttr = isReply ? '' : `onclick="openSheet('${post.id}', '${post.username}', '${(post.content||'').replace(/'/g, "\\'").substring(0,40)}...')"`;
    
    return `
    <div class="${isReply ? 'reply-post' : 'main-post'} animate-in">
        ${post.image_url ? `<img src="${post.image_url}" class="post-img" loading="lazy">` : ''}
        <div class="post-header">
            <div class="avatar">${avatarLetter}</div>
            <div class="username">@${post.username} ${post.target_username ? '<span>üîí</span>' : ''}</div>
        </div>
        <div class="post-text">${post.content || ''}</div>
        ${!isReply ? `
        <div class="post-actions">
            <div class="action-btn" ${replyAttr}>‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</div>
             ${post.user_id === myId ? `<div class="action-btn" style="color:#ff3b30" onclick="deletePost('${post.id}')">üóë –£–¥–∞–ª–∏—Ç—å</div>` : ''}
        </div>` : ''}
    </div>`;
}

async function loadFeed() {
    const feed = document.getElementById('feed');
    // –ù–µ –æ—á–∏—â–∞–µ–º feed –ø–æ–ª–Ω–æ—Å—Ç—å—é, —á—Ç–æ–±—ã –Ω–µ –º–∏–≥–∞–ª–æ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö, –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–º–Ω—ã–π diff, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ —Ç–∞–∫.
    
    const { data: posts, error } = await db.from('posts').select('*').order('created_at', { ascending: false });
    if (error || !posts) return;

    feed.innerHTML = '';

    const mainPosts = posts.filter(p => !p.parent_id);
    const repliesMap = new Map();
    posts.filter(p => p.parent_id).forEach(r => {
        if (!repliesMap.has(r.parent_id)) repliesMap.set(r.parent_id, []);
        repliesMap.get(r.parent_id).push(r);
    });

    let delayTime = 0;

    mainPosts.forEach((post) => {
        const container = document.createElement('div');
        container.className = 'post-container';
        
        // –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Å—Ç
        let html = renderPostHTML(post, false);
        
        // –û—Ç–≤–µ—Ç—ã
        const postReplies = repliesMap.get(post.id);
        if (postReplies && postReplies.length > 0) {
            html += '<div class="replies-thread">';
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç—ã –æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º, —á—Ç–æ–±—ã —á–∏—Ç–∞—Ç—å —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏
            postReplies.sort((a,b) => new Date(a.created_at) - new Date(b.created_at))
                .forEach(reply => {
                html += renderPostHTML(reply, true);
            });
            html += '</div>';
        }

        container.innerHTML = html;
        feed.appendChild(container);

        // –ö–∞—Å–∫–∞–¥–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
        const animatedElements = container.querySelectorAll('.animate-in');
        animatedElements.forEach(el => {
            el.style.animationDelay = `${delayTime}ms`;
            delayTime += 80; // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        });
    });
}

// --- –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• ---
async function sendPost() {
    const txt = document.getElementById('postText').value.trim();
    const file = document.getElementById('fileInput').files[0];
    if (!txt && !file) return;

    const btn = document.getElementById('sendBtn');
    const originalText = btn.innerText;
    btn.disabled = true; btn.innerText = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

    let imageUrl = null;
    if (file) {
        const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9]/g, '')}`;
        const { error: upErr } = await db.storage.from('images').upload(fileName, file);
        if (!upErr) {
            imageUrl = db.storage.from('images').getPublicUrl(fileName).data.publicUrl;
        }
    }

    await db.from('posts').insert([{
        content: txt,
        username: myUsername,
        user_id: myId,
        parent_id: currentReplyId,
        image_url: imageUrl
    }]);

    closeSheet();
    btn.disabled = false; btn.innerText = originalText;
    // –í–∏–±—Ä–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞
    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
}

async function deletePost(id) {
    if(confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?')) {
        await db.from('posts').delete().eq('id', id);
    }
}

// --- –ó–ê–ü–£–°–ö ---
loadFeed();
// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
db.channel('public:posts').on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, (payload) => {
    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ª–µ–Ω—Ç—É. –í –∏–¥–µ–∞–ª–µ - –¥–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç.
    loadFeed();
    // –ï—Å–ª–∏ –ø—Ä–∏—à–µ–ª –Ω–æ–≤—ã–π –ø–æ—Å—Ç –Ω–µ –æ—Ç –º–µ–Ω—è - –ª–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è
    if(payload.eventType === 'INSERT' && payload.new.user_id !== myId && tg.HapticFeedback) {
         tg.HapticFeedback.impactOccurred('light');
    }
}).subscribe();
</script>
</body>
</html>
