<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>OpenEcho Pro Fix</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #000; --text: #fff; --accent: #0a84ff;
  --card-bg: rgba(255, 255, 255, 0.08);
  --border: rgba(255, 255, 255, 0.12);
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); padding: 20px 20px 100px; }

#feed { width: 100%; max-width: 600px; margin: 0 auto; }
.card { background: var(--card-bg); border-radius: 24px; margin-bottom: 16px; backdrop-filter: blur(25px); border: 1px solid var(--border); overflow: hidden; }
.card-content { padding: 18px; }
.text { font-size: 15px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
.text a { color: var(--accent); text-decoration: underline; }

/* –ö–ê–†–¢–û–ß–ö–ê –°–°–´–õ–ö–ò */
.link-preview {
  margin-top: 12px; background: rgba(255, 255, 255, 0.05); 
  border-radius: 16px; padding: 12px; display: flex; align-items: center; gap: 12px; 
  border: 1px solid var(--border); text-decoration: none; color: inherit;
}
.link-icon { width: 32px; height: 32px; border-radius: 8px; background: #222; }

.post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
.avatar { width: 32px; height: 32px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 1px solid var(--border); }
.post-img { width: 100%; max-height: 400px; object-fit: cover; }

.footer { display: flex; gap: 18px; margin-top: 15px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 12px; }
.btn { cursor: pointer; opacity: 0.6; }

.add-btn { position: fixed; bottom: 30px; right: 25px; width: 64px; height: 64px; background: #fff; color: #000; border-radius: 50%; border: none; font-size: 32px; z-index: 100; }
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
.modal.show { display: flex; }
.modal-content { background: #1c1c1e; width: 100%; max-width: 400px; padding: 25px; border-radius: 30px; border: 1px solid var(--border); }
textarea { width: 100%; background: transparent; border: none; color: #fff; font-size: 18px; outline: none; resize: none; min-height: 120px; }
</style>
</head>
<body>

<div id="feed">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<button class="add-btn" onclick="openModal()">+</button>

<div id="modal" class="modal" onclick="if(event.target==this) closeModal()">
    <div class="modal-content">
        <div id="replyBox" style="display:none; margin-bottom:15px; padding-left:10px; border-left:2px solid var(--accent)">
            <div id="reAuthor" style="font-size:12px; color:var(--accent); font-weight:700"></div>
        </div>
        <textarea id="txt" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É..."></textarea>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button onclick="document.getElementById('fInp').click()" style="color:var(--accent); background:none; border:none; font-weight:700">üì∑ –ö–∞–¥—Ä</button>
            <input type="file" id="fInp" hidden accept="image/*">
            <button id="sendBtn" onclick="send()" style="background:var(--accent); color:#fff; border:none; padding:12px 25px; border-radius:18px; font-weight:700">–ü–æ—Å—Ç</button>
        </div>
    </div>
</div>

<script>
const tg = window.Telegram.WebApp;
const db = supabase.createClient('https://xddulhzvzemmrhrsjfhb.supabase.co', 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j');

const user = tg.initDataUnsafe?.user;
const myId = user?.id?.toString() || 'guest';
const myUsername = user?.username || user?.first_name || 'Guest';
const myPhoto = user?.photo_url || '';
let replyId = null;

function formatPost(text) {
    if (!text) return { html: '', preview: '' };
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    const links = text.match(urlRegex);
    let html = text.replace(urlRegex, (url) => `<a href="${url}" target="_blank">${url}</a>`);
    let preview = '';
    if (links) {
        const domain = new URL(links[0]).hostname;
        preview = `<a href="${links[0]}" target="_blank" class="link-preview">
            <img src="https://www.google.com/s2/favicons?sz=64&domain=${domain}" class="link-icon">
            <div style="font-size:13px; font-weight:700">${domain}</div>
        </a>`;
    }
    return { html, preview };
}

async function load() {
    const { data, error } = await db.from('posts').select('*').order('created_at', { ascending: false });
    if (error) { console.error(error); return; }
    const feed = document.getElementById('feed');
    feed.innerHTML = '';
    data.forEach(post => {
        const { html, preview } = formatPost(post.content);
        const card = document.createElement('div');
        card.className = 'card';
        const avatar = post.avatar_url ? `<img src="${post.avatar_url}" class="avatar">` : `<div class="avatar">${post.username[0]}</div>`;
        card.innerHTML = `
            ${post.image_url ? `<img src="${post.image_url}" class="post-img">` : ''}
            <div class="card-content">
                <div class="post-header">${avatar} <div style="font-weight:700">@${post.username}</div></div>
                <div class="text">${html}</div>
                ${preview}
                <div class="footer">
                    <span class="btn" onclick="setupReply('${post.id}','${post.username}')">üí¨ –û—Ç–≤–µ—Ç</span>
                    ${post.user_id === myId ? `<span class="btn" style="color:red" onclick="del('${post.id}')">üóë</span>` : ''}
                </div>
            </div>`;
        feed.appendChild(card);
    });
}

async function send() {
    const t = document.getElementById('txt').value.trim();
    const btn = document.getElementById('sendBtn');
    btn.disabled = true;

    try {
        const { error } = await db.from('posts').insert([{ 
            content: String(t), 
            username: myUsername, 
            user_id: myId, 
            parent_id: replyId, 
            avatar_url: myPhoto 
        }]);

        if (error) throw error;
        closeModal();
        load();
    } catch(e) {
        alert("–û—à–∏–±–∫–∞ Supabase: " + e.message);
        console.error(e);
    } finally {
        btn.disabled = false;
    }
}

function openModal() { document.getElementById('modal').classList.add('show'); }
function closeModal() { document.getElementById('modal').classList.remove('show'); document.getElementById('txt').value = ''; replyId = null; }
function setupReply(id, u) { replyId = id; document.getElementById('reAuthor').innerText = '–û—Ç–≤–µ—Ç @'+u; document.getElementById('replyBox').style.display = 'block'; openModal(); }
async function del(id) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { await db.from('posts').delete().eq('id', id); load(); } }

load();
</script>
</body>
</html>
