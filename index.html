<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OpenEcho Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #000000;
            --card-bg: rgba(28, 28, 30, 0.6);
            --accent: #0a84ff;
            --text: #ffffff;
            --border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: env(safe-area-inset-top) 20px calc(100px + env(safe-area-inset-bottom)) 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 1000px; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è iPad */
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞: 1 –∫–æ–ª–æ–Ω–∫–∞ –Ω–∞ iPhone, 2 –Ω–∞ iPad */
        #feed { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 16px; 
        }

        .card {
            background: var(--card-bg); 
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px);
            border-radius: 24px; 
            padding: 20px; 
            border: 1px solid var(--border); 
            height: fit-content;
            overflow: hidden; /* –ß—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–ª–µ—Ç–∞–ª–æ */
            display: flex;
            flex-direction: column;
        }

        /* –§–ò–ö–° –¢–ï–ö–°–¢–ê: –ß—Ç–æ–±—ã –Ω–µ –≤—ã–ª–µ–∑–∞–ª –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã */
        .text { 
            font-size: 16px; 
            line-height: 1.5; 
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .post-img { 
            width: calc(100% + 40px); 
            margin: -20px -20px 15px -20px; 
            max-height: 450px; 
            object-fit: cover; 
        }

        .author { color: var(--accent); font-weight: 700; font-size: 14px; margin-bottom: 8px; }

        /* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
        .add-btn { 
            position: fixed; 
            bottom: calc(30px + env(safe-area-inset-bottom)); 
            right: 30px; 
            width: 60px; height: 60px; 
            background: var(--accent); 
            border-radius: 50%; border: none; color: white; 
            font-size: 30px; z-index: 99; 
            box-shadow: 0 8px 20px rgba(10,132,255,0.3);
        }

        /* –ú–æ–¥–∞–ª–∫–∞ */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); 
            z-index: 100; align-items: center; justify-content: center; padding: 20px; 
        }
        .modal.show { display: flex; }
        .modal-content { 
            background: #1c1c1e; border-radius: 30px; padding: 25px; 
            width: 100%; max-width: 450px; border: 1px solid var(--border); 
        }

        textarea { 
            width: 100%; background: transparent; border: none; color: white; 
            font-size: 18px; outline: none; resize: none; min-height: 120px; 
            margin: 15px 0; font-family: inherit;
        }

        .reply-box { 
            background: rgba(255,255,255,0.05); padding: 10px; 
            border-radius: 12px; border-left: 3px solid var(--accent); 
            margin-bottom: 10px; font-size: 13px;
        }
        
        #mediaPreview img { width: 80px; height: 80px; border-radius: 12px; object-fit: cover; }
    </style>
</head>
<body>

<div class="container">
    <div id="feed"></div>
</div>

<button class="add-btn" onclick="openModal()">+</button>

<div id="modal" class="modal" onclick="if(event.target==this) closeModal()">
    <div class="modal-content">
        <div id="replyPreview" style="display:none" class="reply-box">
            <div id="replyAuthor" style="font-weight:700; color:var(--accent)"></div>
            <div id="replyText"></div>
        </div>
        <div id="mediaPreview" style="display:none"><img id="previewImg" src=""></div>
        <textarea id="txt" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
        <div style="display:flex; justify-content:space-between;">
            <button onclick="document.getElementById('fileInput').click()" style="background:none; border:none; color:var(--accent); font-weight:600;">üì∑ –§–æ—Ç–æ</button>
            <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile()">
            <button id="sendBtn" onclick="send()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:12px; font-weight:700;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
const tg = window.Telegram.WebApp;
const haptic = tg.HapticFeedback;
tg.expand();

const SUPABASE_URL = 'https://xddulhzvzemmrhrsjfhb.supabase.co';
const SUPABASE_KEY = 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const myId = tg.initDataUnsafe?.user?.id?.toString() || 'guest';
const myUsername = tg.initDataUnsafe?.user?.username || 'Guest';
let replyId = null;

// –°–∂–∞—Ç–∏–µ —Ñ–æ—Ç–æ
async function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_W = 1200;
                let w = img.width, h = img.height;
                if (w > MAX_W) { h *= MAX_W / w; w = MAX_W; }
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                canvas.toBlob((blob) => resolve(new File([blob], file.name, {type:'image/jpeg'})), 'image/jpeg', 0.7);
            };
        };
    });
}

async function load() {
    const { data, error } = await db.from('posts').select('*').order('created_at', { ascending: false });
    if (error) return;
    const feed = document.getElementById('feed');
    feed.innerHTML = '';
    data.forEach(post => {
        const card = document.createElement('div');
        card.className = 'card';
        let replyHtml = '';
        if (post.parent_id) {
            const parent = data.find(p => p.id === post.parent_id);
            if (parent) replyHtml = `<div class="reply-box"><b>@${parent.username}</b>: ${parent.content?.substring(0,20)}...</div>`;
        }
        card.innerHTML = `
            ${post.image_url ? `<img src="${post.image_url}" class="post-img">` : ''}
            <div class="author">@${post.username}</div>
            ${replyHtml}
            <div class="text">${post.content || ''}</div>
            <div style="margin-top:15px; display:flex; gap:20px; font-size:13px; font-weight:700;">
                <span style="color:var(--accent);" onclick="setupReply('${post.id}','${post.username}','${(post.content||'').substring(0,20)}')">üí¨ –û—Ç–≤–µ—Ç</span>
                ${post.user_id === myId ? `<span style="color:#ff453a;" onclick="del('${post.id}')">üóë –£–¥–∞–ª–∏—Ç—å</span>` : ''}
            </div>`;
        feed.appendChild(card);
    });
}

async function send() {
    const txt = document.getElementById('txt').value.trim();
    let file = document.getElementById('fileInput').files[0];
    if (!txt && !file) return;
    const btn = document.getElementById('sendBtn');
    btn.disabled = true;
    try {
        let imageUrl = null;
        if (file) {
            file = await compressImage(file);
            const name = `${Date.now()}.jpg`;
            await db.storage.from('images').upload(name, file);
            imageUrl = db.storage.from('images').getPublicUrl(name).data.publicUrl;
        }
        await db.from('posts').insert([{ content: txt, username: myUsername, user_id: myId, parent_id: replyId, image_url: imageUrl }]);
        haptic.notificationOccurred('success');
        closeModal(); load();
    } catch (e) { alert(e.message); }
    btn.disabled = false;
}

function handleFile() {
    const file = document.getElementById('fileInput').files[0];
    if (file) {
        document.getElementById('previewImg').src = URL.createObjectURL(file);
        document.getElementById('mediaPreview').style.display = 'block';
    }
}

function openModal() { document.getElementById('modal').classList.add('show'); haptic.impactOccurred('light'); }
function closeModal() { 
    document.getElementById('modal').classList.remove('show'); 
    replyId = null; document.getElementById('txt').value = ''; 
    document.getElementById('mediaPreview').style.display = 'none';
}

function setupReply(id, user, text) {
    replyId = id;
    document.getElementById('replyAuthor').innerText = '@' + user;
    document.getElementById('replyText').innerText = text;
    document.getElementById('replyPreview').style.display = 'block';
    openModal();
}

async function del(id) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { await db.from('posts').delete().eq('id', id); load(); } }

load();
db.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, load).subscribe();
</script>
</body>
</html>
