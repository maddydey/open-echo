<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ECHO FIX</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { 
            --bg: #000; 
            --glass: rgba(255, 255, 255, 0.07);
            --glass-border: rgba(255, 255, 255, 0.12);
            --accent: #0a84ff;
            --gold: #ffd700;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui, sans-serif; background: #000; color: #fff; height: 100vh; overflow: hidden; }

        /* –§–∏–∫—Å —á–µ—Ä–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞: –∑–∞–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –∏ —Ñ–æ–Ω */
        #app { 
            height: 100vh; overflow-y: auto; 
            padding: calc(env(safe-area-inset-top) + 20px) 16px 220px;
            background: radial-gradient(circle at 50% 0%, #111 0%, #000 100%);
            -webkit-overflow-scrolling: touch;
        }

        .post-group { display: flex; flex-direction: column; margin-bottom: 35px; opacity: 0; animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }

        .card { 
            background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); border-radius: 30px; padding: 20px; z-index: 2;
        }

        /* –°–∏–Ω—è—è –æ–±–≤–æ–¥–∫–∞ –∞–≤–∞—Ç–∞—Ä–æ–∫ */
        .avatar-box {
            width: 42px; height: 42px; border-radius: 50%;
            border: 2px solid var(--accent);
            box-shadow: 0 0 10px rgba(10, 132, 255, 0.5);
            overflow: hidden; flex-shrink: 0;
        }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }

        .substrate {
            margin: -12px 15px 0; padding: 22px 18px 10px;
            background: rgba(255, 255, 255, 0.03); border: 1px solid var(--glass-border); border-top: none;
            border-radius: 0 0 22px 22px; font-size: 9px; color: rgba(255,255,255,0.3); letter-spacing: 1px;
        }

        .is-master .card { border-color: rgba(255, 215, 0, 0.4); }
        .is-master .avatar-box { border-color: var(--gold); box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .is-master .username { color: var(--gold); }

        /* UI –ö–Ω–æ–ø–∫–∏ */
        .nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(20,20,20,0.8); backdrop-filter: blur(20px); padding: 8px; border-radius: 100px; display: flex; border: 1px solid var(--glass-border); z-index: 1000; }
        .nav-item { width: 55px; height: 45px; display: flex; align-items: center; justify-content: center; opacity: 0.3; font-size: 22px; }
        .nav-item.active { opacity: 1; }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px; background: #fff; border-radius: 50%; border: none; font-size: 30px; z-index: 1000; font-weight: bold; }
    </style>
</head>
<body>

<div id="app">
    <div id="header" style="text-align:center; padding-bottom:30px; font-size:28px; font-weight:900; letter-spacing:2px;">ECHO</div>
    <div id="feed">
        <div style="text-align:center; opacity:0.5; margin-top:50px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞...</div>
    </div>
</div>

<div class="nav">
    <div class="nav-item active" onclick="location.reload()">üè†</div>
    <div class="nav-item" onclick="tg.showAlert('–ü—Ä–æ—Ñ–∏–ª—å –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">üë§</div>
</div>
<button class="fab" onclick="openM()">+</button>

<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:5000; align-items:flex-end;">
    <div style="width:100%; background:#111; border-radius:30px 30px 0 0; padding:25px; border-top:1px solid var(--glass-border);">
        <textarea id="txt" style="width:100%; height:100px; background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); border-radius:15px; color:#fff; padding:15px; margin-bottom:15px; font-size:16px;" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
        <input id="linkInp" style="width:100%; background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); border-radius:12px; color:#fff; padding:12px; margin-bottom:15px;" placeholder="–°—Å—ã–ª–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
        <button id="sendBtn" style="width:100%; padding:18px; border-radius:18px; border:none; background:#fff; font-weight:900;" onclick="send()">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>
        <button style="width:100%; padding:10px; color:#555; background:none; border:none;" onclick="closeM()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
    let db;
    try {
        db = supabase.createClient('https://xddulhzvzemmrhrsjfhb.supabase.co', 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j');
    } catch (e) {
        console.error("Supabase init error", e);
    }

    const myId = tg.initDataUnsafe?.user?.id?.toString() || 'guest';
    const myName = tg.initDataUnsafe?.user?.username || 'Guest';
    const myAvatar = tg.initDataUnsafe?.user?.photo_url || '';

    const MASTER_USER = "sqwozzpapp";

    async function load() {
        const feed = document.getElementById('feed');
        try {
            const { data, error } = await db.from('posts').select('*').order('created_at', { ascending: false });
            if (error) throw error;
            render(data);
        } catch (e) {
            feed.innerHTML = `<div style="text-align:center; padding:20px; color:red;">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ VPN –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase.</div>`;
        }
    }

    function render(data) {
        const feed = document.getElementById('feed');
        feed.innerHTML = '';
        if (!data || data.length === 0) {
            feed.innerHTML = '<div style="text-align:center; opacity:0.3; margin-top:50px;">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞</div>';
            return;
        }

        data.forEach(p => {
            const isMaster = p.username === MASTER_USER;
            const group = document.createElement('div');
            group.className = `post-group ${isMaster ? 'is-master' : ''}`;

            group.innerHTML = `
                <div class="card">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                        <div class="avatar-box">
                            <img src="${p.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                        </div>
                        <div style="flex:1">
                            <div class="username" style="font-weight:800; font-size:15px;">@${p.username}</div>
                            <div style="font-size:9px; opacity:0.4; text-transform:uppercase;">${isMaster ? 'Master Status' : 'Echo User'}</div>
                        </div>
                        ${p.user_id === myId ? `<div onclick="del('${p.id}')" style="opacity:0.2;">‚úï</div>` : ''}
                    </div>
                    <div style="font-size:16px; line-height:1.4; color:rgba(255,255,255,0.9);">${p.content}</div>
                    ${p.track_url ? `<div style="margin-top:10px; font-size:12px; color:var(--accent); text-decoration:underline;" onclick="tg.openLink('${p.track_url}')">üîó –°—Å—ã–ª–∫–∞</div>` : ''}
                </div>
                <div class="substrate">${isMaster ? 'SECURE MASTER NODE' : 'ENCRYPTED DATA'}</div>
            `;
            feed.appendChild(group);
        });
    }

    function openM() { document.getElementById('modal').style.display = 'flex'; }
    function closeM() { document.getElementById('modal').style.display = 'none'; }

    async function send() {
        const t = document.getElementById('txt').value;
        const l = document.getElementById('linkInp').value;
        if(!t) return;
        const btn = document.getElementById('sendBtn');
        btn.disabled = true; btn.innerText = "SENDING...";

        try {
            await db.from('posts').insert([{ 
                content: t, 
                username: myName, 
                user_id: myId, 
                avatar_url: myAvatar, 
                track_url: l 
            }]);
            closeM(); load();
        } catch(e) {
            tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ");
        } finally {
            btn.disabled = false; btn.innerText = "PUBLISH";
            document.getElementById('txt').value = '';
        }
    }

    async function del(id) {
        if(confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?')) {
            await db.from('posts').delete().eq('id', id);
            load();
        }
    }

    // –ó–∞–ø—É—Å–∫
    window.onload = load;
</script>
</body>
</html>
