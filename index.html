<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenEcho Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #000000;
            --card-bg: rgba(28, 28, 30, 0.7);
            --accent: #0a84ff;
            --text-main: #ffffff;
            --text-dim: #8e8e93;
        }

        body { 
            background: var(--bg); color: var(--text-main); 
            font-family: -apple-system, system-ui, sans-serif; 
            margin: 0; padding: 20px; padding-bottom: 120px;
            overflow-x: hidden; -webkit-font-smoothing: antialiased;
        }

        /* –õ–ï–ù–¢–ê –ü–û–°–¢–û–í */
        #feed { display: flex; flex-direction: column; gap: 14px; }

        .echo-card { 
            background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 26px; border: 1px solid rgba(255, 255, 255, 0.1); 
            opacity: 0; transform: translateY(25px) scale(0.98);
            animation: emerge 0.4s cubic-bezier(0.17, 0.89, 0.32, 1.2) forwards;
        }
        @keyframes emerge { to { opacity: 1; transform: translateY(0) scale(1); } }

        .post-img { width: 100%; border-radius: 26px 26px 0 0; cursor: pointer; display: block; }
        .card-content { padding: 18px; }
        .author { color: var(--accent); font-weight: 700; font-size: 14px; margin-bottom: 6px; }

        /* –ö–ù–û–ü–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø */
        .btn-add { 
            position: fixed; bottom: 30px; right: 24px; 
            width: 64px; height: 64px; background: var(--accent); 
            border-radius: 50%; border: none; color: white; font-size: 32px;
            box-shadow: 0 12px 30px rgba(10, 132, 255, 0.4); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-add:active { transform: scale(0.8) rotate(90deg); }

        /* –û–ö–ù–û –°–û–ó–î–ê–ù–ò–Ø –ü–û–°–¢–ê */
        #modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            z-index: 1000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }
        .modal-window {
            background: #1c1c1e; width: 100%; max-width: 400px;
            border-radius: 32px; border: 1px solid rgba(255,255,255,0.15);
            padding: 24px; box-sizing: border-box;
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
            transform: scale(0.9) translateY(30px); opacity: 0;
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* –û–ö–ù–û –ü–†–û–°–ú–û–¢–†–ê –§–û–¢–û */
        #imageOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 2000; justify-content: center; align-items: center; padding: 20px;
        }
        .image-window {
            position: relative; max-width: 100%; animation: popIn 0.3s ease forwards;
        }
        .image-window img { width: 100%; max-height: 80vh; border-radius: 28px; box-shadow: 0 20px 40px rgba(0,0,0,0.8); }

        @keyframes popIn { to { opacity: 1; transform: scale(1) translateY(0); } }

        /* –ò–ù–¢–ï–†–§–ï–ô–° –í–ù–£–¢–†–ò –û–ö–û–ù */
        textarea { width: 100%; background: transparent; border: none; color: white; font-size: 18px; outline: none; resize: none; }
        .input-field { width: 100%; background: rgba(255,255,255,0.06); border: none; border-radius: 14px; padding: 14px; color: white; margin: 15px 0; font-size: 15px; }
        
        #mediaPreview { width: 75px; height: 75px; margin-bottom: 15px; border-radius: 14px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1); }

        .loader { width: 20px; height: 20px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <h2 style="font-weight: 800; font-size: 28px; margin-bottom: 25px; letter-spacing: -1.5px;">OpenEcho</h2>
    
    <div id="feed"></div>

    <button class="btn-add" onclick="openModal()">+</button>

    <div id="modal" onclick="if(event.target == this) closeModal()">
        <div class="modal-window">
            <textarea id="postText" rows="4" placeholder="–û —á–µ–º —Ç—ã –¥—É–º–∞–µ—à—å?"></textarea>
            
            <div id="mediaPreview" style="display:none">
                <img id="previewImg" style="width:100%; height:100%; object-fit:cover;">
                <div onclick="clearMedia()" style="position:absolute; top:4px; right:4px; background:rgba(255,69,58,0.9); color:white; border-radius:50%; width:20px; height:20px; text-align:center; line-height:20px; font-size:12px; font-weight:bold;">‚úï</div>
            </div>

            <input type="text" id="targetUser" class="input-field" placeholder="–ü—Ä–∏–≤–∞—Ç–Ω–æ –¥–ª—è: @username">
            
            <input type="file" id="fileInput" accept="image/*" onchange="updateFileName()" style="display:none">

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button onclick="document.getElementById('fileInput').click()" style="background:none; border:none; color:var(--accent); font-weight:600; font-size:16px;">üñº –ú–µ–¥–∏–∞</button>
                <button id="submitBtn" onclick="sendPost()" style="background:var(--accent); color:white; border:none; padding:12px 28px; border-radius:18px; font-weight:700; min-width:110px; display:flex; justify-content:center;">
                    <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                </button>
            </div>
        </div>
    </div>

    <div id="imageOverlay" onclick="closeFullImage()">
        <div class="image-window" onclick="event.stopPropagation()">
            <img id="fullImage" src="">
            <div onclick="closeFullImage()" style="position:absolute; top:-50px; right:0; color:white; font-size:18px; font-weight:600; background:rgba(255,255,255,0.1); padding:8px 15px; border-radius:20px;">–ó–∞–∫—Ä—ã—Ç—å ‚úï</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const SUPABASE_URL = 'https://xddulhzvzemmrhrsjfhb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const currentUserId = tg.initDataUnsafe?.user?.id?.toString();

        async function loadEchos() {
            const { data } = await supabaseClient.from('posts').select('*').order('created_at', { ascending: false });
            const feed = document.getElementById('feed');
            if (!data) return;

            const myName = tg.initDataUnsafe?.user?.username;
            feed.innerHTML = '';

            data.forEach((post, index) => {
                const isMy = post.user_id === currentUserId;
                const isForMe = post.target_username && myName === post.target_username;
                const isPublic = !post.target_username;

                if (isPublic || isMy || isForMe) {
                    const card = document.createElement('div');
                    card.className = 'echo-card';
                    card.style.animationDelay = `${index * 0.04}s`;
                    card.innerHTML = `
                        ${post.image_url ? `<img src="${post.image_url}" class="post-img" onclick="openFullImage('${post.image_url}')">` : ''}
                        <div class="card-content">
                            <div class="author">@${post.username} ${post.target_username ? 'üîí' : ''}</div>
                            <div style="font-size:16px; line-height:1.5; color:#eee;">${post.content}</div>
                            <div style="margin-top:14px; font-size:13px; color:var(--accent); font-weight:600; cursor:pointer;" onclick="openModal('${post.id}', '${post.username}')">–û—Ç–≤–µ—Ç–∏—Ç—å</div>
                        </div>`;
                    feed.appendChild(card);
                }
            });
        }

        function openModal() {
            document.getElementById('modal').style.display = 'flex';
            setTimeout(() => document.getElementById('postText').focus(), 100);
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('postText').value = '';
            clearMedia();
        }

        function openFullImage(url) {
            document.getElementById('fullImage').src = url;
            document.getElementById('imageOverlay').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeFullImage() {
            document.getElementById('imageOverlay').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function updateFileName() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('mediaPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function clearMedia() {
            document.getElementById('fileInput').value = "";
            document.getElementById('mediaPreview').style.display = 'none';
        }

        async function sendPost() {
            const btn = document.getElementById('submitBtn');
            const text = document.getElementById('postText').value;
            const target = document.getElementById('targetUser').value.replace('@', '').trim();
            let file = document.getElementById('fileInput').files[0];

            if(!text && !file) return;
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div>';

            let imageUrl = null;
            if (file) {
                const name = `${Date.now()}.jpg`;
                const { data } = await supabaseClient.storage.from('images').upload(name, file);
                if (data) imageUrl = supabaseClient.storage.from('images').getPublicUrl(name).data.publicUrl;
            }

            await supabaseClient.from('posts').insert([{
                username: tg.initDataUnsafe?.user?.username || "Guest",
                content: text,
                user_id: currentUserId,
                image_url: imageUrl,
                target_username: target || null
            }]);

            btn.disabled = false;
            btn.innerHTML = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            closeModal();
            loadEchos();
        }

        loadEchos();
        supabaseClient.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, loadEchos).subscribe();
    </script>
</body>
</html>
