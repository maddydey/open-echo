<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenEcho</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --bg:#f5f5f5;
  --card:#fff;
  --text:#111;
  --muted:#777;
  --accent:#1b6ef3;
}

body {
  margin:0;
  padding:16px;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  color:var(--text);
}

.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
}

h2 { margin:0 }

.card {
  background:var(--card);
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
  box-shadow:0 4px 16px rgba(0,0,0,.08);
}

.author {
  font-weight:600;
  color:var(--accent);
  margin-bottom:6px;
}

.text {
  font-size:14px;
  line-height:1.4;
}

.img {
  width:100%;
  border-radius:12px;
  margin-top:8px;
}

.actions {
  display:flex;
  gap:16px;
  margin-top:8px;
  font-size:13px;
}

.btn { color:var(--accent); cursor:pointer }
.btn-del { color:#ff3b30 }

.add-btn {
  position:fixed;
  bottom:24px;
  right:24px;
  width:56px;
  height:56px;
  border-radius:50%;
  background:var(--accent);
  color:#fff;
  border:none;
  font-size:26px;
}

.modal {
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.6);
}

.modal.show { display:flex }

.modal-content {
  background:#fff;
  border-radius:16px;
  padding:16px;
  width:100%;
  max-width:400px;
}

textarea,input {
  width:100%;
  border-radius:12px;
  border:1px solid #ddd;
  padding:10px;
  margin-bottom:10px;
  font-size:14px;
}

.send-btn {
  width:100%;
  background:var(--accent);
  color:#fff;
  border:none;
  padding:12px;
  border-radius:12px;
  font-weight:600;
}
</style>
</head>

<body>

<div class="header">
  <h2>OpenEcho</h2>
</div>

<div id="feed">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°â€¦</div>

<button class="add-btn" onclick="openModal()">+</button>

<div id="modal" class="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal-content">
    <textarea id="txt" rows="4" placeholder="Ð§Ñ‚Ð¾ Ð½Ð¾Ð²Ð¾Ð³Ð¾?"></textarea>
    <input id="target" placeholder="ÐŸÑ€Ð¸Ð²Ð°Ñ‚Ð½Ð¾ Ð´Ð»Ñ @username">
    <button class="send-btn" onclick="send()">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const SUPABASE_URL = 'https://xddulhzvzemmrhrsjfhb.supabase.co';
const SUPABASE_KEY = 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j';

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let userId = 'test';
let username = 'test';

if (tg.initDataUnsafe?.user) {
  userId = String(tg.initDataUnsafe.user.id);
  username = tg.initDataUnsafe.user.username || userId;
}

function esc(t){
  const d=document.createElement('div');
  d.textContent=t||'';
  return d.innerHTML;
}

async function load(){
  const { data, error } = await db
    .from('posts')
    .select('*')
    .or(`target_username.is.null,target_username.eq.${username}`)
    .order('created_at',{ascending:false})
    .limit(50);

  const feed=document.getElementById('feed');
  feed.innerHTML='';

  if(error){
    feed.innerHTML='ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸';
    console.error(error);
    return;
  }

  if(!data.length){
    feed.innerHTML='ÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ð¿Ð¾ÑÑ‚Ð¾Ð²';
    return;
  }

  data.forEach(p=>{
    const card=document.createElement('div');
    card.className='card';

    card.innerHTML=`
      <div class="author">@${esc(p.username)} ${p.target_username?'ðŸ”’':''}</div>
      ${p.content?`<div class="text">${esc(p.content)}</div>`:''}
      ${p.image_url?`<img class="img" src="${p.image_url}">`:''}
      <div class="actions">
        ${p.user_id===userId?`<span class="btn btn-del" onclick="del('${p.id}')">Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ</span>`:''}
      </div>
    `;
    feed.appendChild(card);
  });
}

function openModal(){
  document.getElementById('modal').classList.add('show');
}

function closeModal(){
  document.getElementById('modal').classList.remove('show');
  document.getElementById('txt').value='';
  document.getElementById('target').value='';
}

async function send(){
  const text=document.getElementById('txt').value.trim();
  const target=document.getElementById('target').value.replace('@','').trim();

  if(!text) return;

  await db.from('posts').insert([{
    username,
    user_id:userId,
    content:text,
    target_username:target||null
  }]);

  closeModal();
  load();
}

async function del(id){
  await db.from('posts').delete().eq('id',id).eq('user_id',userId);
  load();
}

load();
</script>

</body>
</html>
