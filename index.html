<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenEcho One UI</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #f5f5f5;
  --card-bg: rgba(255, 255, 255, 0.7);
  --text: #1a1a1a;
  --text-dim: #666;
  --accent: #1b6ef3;
  --border: rgba(0,0,0,0.08);
  --shadow: rgba(0,0,0,0.1);
}
[data-theme="dark"] {
  --bg: #0a0a0a;
  --card-bg: rgba(30,30,30,0.7);
  --text: #e5e5e5;
  --text-dim: #999;
  --accent: #5093ff;
  --border: rgba(255,255,255,0.1);
  --shadow: rgba(0,0,0,0.5);
}
* { box-sizing:border-box; margin:0; padding:0; }
body {
  font-family: -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 20px 20px 100px;
  transition: background 0.3s, color 0.3s;
}
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
h2 { font-size:28px; font-weight:700; }
.theme-btn {
  width:44px; height:44px; border-radius:50%; background:var(--card-bg);
  backdrop-filter: blur(20px); border:1px solid var(--border);
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  font-size:20px; box-shadow:0 4px 12px var(--shadow);
}
#feed { display:flex; flex-direction:column; gap:16px; }
.card {
  background: var(--card-bg); backdrop-filter: blur(40px); border-radius:24px;
  padding:20px; border:1px solid var(--border); box-shadow:0 8px 32px var(--shadow);
}
.author { color: var(--accent); font-weight:600; font-size:15px; margin-bottom:10px; }
.text { color: var(--text); line-height:1.5; margin-bottom:12px; word-wrap:break-word; font-size:15px; }
.img { width:100%; border-radius:16px; margin-bottom:12px; cursor:pointer; }
.reply-box {
  background: var(--card-bg); backdrop-filter: blur(20px);
  border-left:3px solid var(--accent); padding:10px 12px; border-radius:12px;
  margin-bottom:12px; font-size:13px; border:1px solid var(--border);
}
.reply-author { font-weight:600; color:var(--accent); margin-bottom:4px; }
.reply-text { color: var(--text-dim); font-size:13px; }
.actions { display:flex; gap:12px; font-size:14px; margin-top:12px; padding-top:12px; border-top:1px solid var(--border); }
.btn { color: var(--accent); cursor:pointer; font-weight:500; }
.btn-del { color:#ff3b30; }
.btn-share { color:#ff9500; }
.add-btn {
  position: fixed; bottom:24px; right:24px; width:60px; height:60px;
  background: linear-gradient(135deg, var(--accent) 0%, #9055ff 100%);
  color:white; border:none; border-radius:50%; font-size:28px; cursor:pointer;
  box-shadow:0 8px 24px rgba(27,110,243,0.4); z-index:100;
}
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(10px); z-index:200; align-items:center; justify-content:center; padding:20px; }
.modal.show { display:flex; }
.modal-content {
  background: var(--card-bg); backdrop-filter:blur(40px); border-radius:24px;
  padding:24px; width:100%; max-width:420px; border:1px solid var(--border); box-shadow:0 20px 60px var(--shadow);
}
textarea { width:100%; border:1px solid var(--border); border-radius:16px; padding:14px; font-size:15px; font-family:inherit; resize:none; margin-bottom:12px; background: var(--card-bg); backdrop-filter:blur(20px); color:var(--text);}
textarea:focus { outline:none; border-color:var(--accent);}
input[type=text] { width:100%; border:1px solid var(--border); border-radius:16px; padding:12px 14px; font-size:14px; margin-bottom:16px; background: var(--card-bg); backdrop-filter:blur(20px); color:var(--text);}
input[type=text]:focus { outline:none; border-color:var(--accent);}
.modal-btns { display:flex; justify-content:space-between; align-items:center; gap:12px; }
.send-btn {
  background: linear-gradient(135deg, var(--accent) 0%, #9055ff 100%);
  color:white; border:none; padding:12px 28px; border-radius:16px;
  font-weight:600; font-size:15px; cursor:pointer;
}
.send-btn:disabled { opacity:0.5; }
.file-btn {
  background: var(--card-bg); backdrop-filter:blur(20px); border:1px solid var(--border);
  color: var(--text); font-size:14px; cursor:pointer; padding:12px 20px; border-radius:16px; font-weight:500;
}
.preview { width:80px; height:80px; position:relative; margin-bottom:12px; border-radius:12px; overflow:hidden; }
.preview img { width:100%; height:100%; object-fit:cover; }
.preview-close { position:absolute; top:-8px; right:-8px; background:#ff3b30; color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:14px; }
.loading, .empty { text-align:center; padding:40px 20px; color:var(--text-dim);}
.error { background: linear-gradient(135deg,#ff3b30 0%,#ff6b6b 100%); color:white; padding:16px; border-radius:16px; margin:20px 0; text-align:center; }
.overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); backdrop-filter:blur(20px); z-index:300; align-items:center; justify-content:center; }
.overlay.show { display:flex; }
.overlay img { max-width:90%; max-height:90%; border-radius:16px; }
</style>
</head>
<body data-theme="light">

<div class="header">
  <h2>OpenEcho üî•</h2>
  <button class="theme-btn" onclick="toggleTheme()" id="themeBtn">üåô</button>
</div>

<div id="feed"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>

<button class="add-btn" onclick="openModal()">+</button>

<div id="modal" class="modal" onclick="if(event.target==this) closeModal()">
  <div class="modal-content">
    <div id="replyBox" style="display:none" class="reply-box">
      <div class="reply-author" id="replyAuthor"></div>
      <div class="reply-text" id="replyText"></div>
    </div>

    <textarea id="txt" rows="4" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>

    <div id="preview" class="preview" style="display:none">
      <img id="previewImg">
      <div class="preview-close" onclick="clearFile()">√ó</div>
    </div>

    <input type="text" id="target" placeholder="–ü—Ä–∏–≤–∞—Ç–Ω–æ –¥–ª—è @username">

    <div class="modal-btns">
      <button class="file-btn" onclick="document.getElementById('file').click()">üì∑ –§–æ—Ç–æ</button>
      <input type="file" id="file" hidden accept="image/*" onchange="showPreview()">
      <button class="send-btn" id="sendBtn" onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<div id="overlay" class="overlay" onclick="closeOverlay()">
  <img id="overlayImg">
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

// ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –î–ê–ù–ù–´–ï
const SUPABASE_URL = 'https://xddulhzvzemmrhrsjfhb.supabase.co';
const SUPABASE_KEY = 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j';

let db = null;
let userId = null;
let username = null;
let replyId = null;

// –¢–µ–º–∞
function toggleTheme() {
  const body = document.body;
  const btn = document.getElementById('themeBtn');
  const current = body.getAttribute('data-theme');
  if(current==='light'){ body.setAttribute('data-theme','dark'); btn.textContent='‚òÄÔ∏è'; localStorage.setItem('theme','dark'); }
  else{ body.setAttribute('data-theme','light'); btn.textContent='üåô'; localStorage.setItem('theme','light'); }
}
const savedTheme = localStorage.getItem('theme') || 'light';
document.body.setAttribute('data-theme', savedTheme);
if(savedTheme==='dark') document.getElementById('themeBtn').textContent='‚òÄÔ∏è';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
async function init(){
  try{
    const user = tg.initDataUnsafe?.user;
    if(!user){ userId='test123'; username='TestUser'; }
    else{ userId=user.id.toString(); username=user.username||'User'+user.id; }
    if(SUPABASE_URL.includes('your-project')) throw new Error('–£–∫–∞–∂–∏—Ç–µ SUPABASE_URL –∏ SUPABASE_KEY');
    db = supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
    await load();
    db.channel('posts-channel')
      .on('postgres_changes',{event:'*',schema:'public',table:'posts'},()=>load())
      .subscribe();
  }catch(e){ console.error('–û—à–∏–±–∫–∞:',e); document.getElementById('feed').innerHTML='<div class="error">–û—à–∏–±–∫–∞: '+e.message+'</div>'; }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤ —Å –≥–∞–ª–µ—Ä–µ–µ–π —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
async function load(){
  try{
    const { data, error } = await db.from('posts')
      .select('*')
      .or(`target_username.is.null,target_username.eq.${username}`)
      .order('created_at',{ascending:false})
      .limit(50);

    const feed = document.getElementById('feed');
    feed.innerHTML='';

    if(error) throw error;
    if(!data || data.length===0){ feed.innerHTML='<div class="empty">üìù<br>–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤</div>'; return; }

    // --- –°–ª—É—á–∞–π–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è (5 –ø–æ—Å—Ç–æ–≤) ---
    const randomPosts = [...data].sort(()=>0.5-Math.random()).slice(0,5);
    if(randomPosts.length>0){
      const gallery = document.createElement('div');
      gallery.style.display='flex'; gallery.style.gap='8px'; gallery.style.marginBottom='16px'; gallery.style.flexWrap='wrap';
      randomPosts.forEach(post=>{
        const div=document.createElement('div');
        div.style.width='calc(20% - 8px)'; div.style.cursor='pointer';
        if(post.image_url){ div.innerHTML=`<img src="${post.image_url}" style="width:100%;border-radius:12px;" onclick="showImage('${post.image_url}')">`; }
        else{ div.innerHTML=`<div style="background:var(--card-bg);height:80px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text);padding:4px;text-align:center;">${esc(post.content||'üìÑ')}</div>`; }
        gallery.appendChild(div);
      });
      feed.appendChild(gallery);
    }

    // --- –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ—Å—Ç—ã ---
    const normalPosts = data.filter(p=>!randomPosts.includes(p));
    normalPosts.forEach(post=>{
      const card=document.createElement('div'); card.className='card';
      let html='';
      if(post.parent_id){
        const parent=data.find(p=>p.id===post.parent_id);
        if(parent){ html+=`<div class="reply-box"><div class="reply-author">@${esc(parent.username)}</div><div class="reply-text">${esc(parent.content||'üì∑')}</div></div>`; }
      }
      html+=`<div class="author">@${esc(post.username)}${post.target_username?' üîí':''}</div>`;
      if(post.image_url){ html+=`<img class="img" src="${post.image_url}" onclick="showImage('${post.image_url}')" loading="lazy">`; }
      if(post.content){ html+=`<div class="text">${esc(post.content)}</div>`; }

      // –î–µ–π—Å—Ç–≤–∏—è + –ø–æ–¥–µ–ª–∏—Ç—å—Å—è
      html+=`<div class="actions">
        <span class="btn" onclick="reply('${post.id}','${esc(post.username)}','${esc((post.content||'').substring(0,40))}')">üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å</span>
        <span class="btn btn-share" onclick="sharePost('${post.id}','${esc(post.content||'')}','${post.image_url||''}')">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
        ${post.user_id===userId?`<span class="btn btn-del" onclick="del('${post.id}')">üóë –£–¥–∞–ª–∏—Ç—å</span>`:''}
      </div>`;

      card.innerHTML=html;
      feed.appendChild(card);
    });

  }catch(e){ console.error('–û—à–∏–±–∫–∞:',e); feed.innerHTML='<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}

function esc(str){ const div=document.createElement('div'); div.textContent=str||''; return div.innerHTML; }

// –ú–æ–¥–∞–ª–∫–∏
function openModal(){ document.getElementById('modal').classList.add('show'); }
function closeModal(){
  document.getElementById('modal').classList.remove('show');
  setTimeout(()=>{
    document.getElementById('txt').value=''; document.getElementById('target').value='';
    document.getElementById('replyBox').style.display='none'; clearFile(); replyId=null;
  },300);
}
function reply(id,user,text){ replyId=id; document.getElementById('replyAuthor').textContent='@'+user; document.getElementById('replyText').textContent=text+'...'; document.getElementById('replyBox').style.display='block'; openModal(); }

// –§–∞–π–ª—ã
function showPreview(){ const file=document.getElementById('file').files[0]; if(!file) return; if(file.size>5*1024*1024){ tg.showAlert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 5–ú–ë)'); document.getElementById('file').value=''; return; } const reader=new FileReader(); reader.onload=e=>{ document.getElementById('previewImg').src=e.target.result; document.getElementById('preview').style.display='block'; }; reader.readAsDataURL(file); }
function clearFile(){ document.getElementById('file').value=''; document.getElementById('preview').style.display='none'; }

// –û—Ç–ø—Ä–∞–≤–∫–∞
async function send(){
  const btn=document.getElementById('sendBtn');
  const text=document.getElementById('txt').value.trim();
  const targetUser=document.getElementById('target').value.replace('@','').trim();
  const file=document.getElementById('file').files[0];
  if(!text && !file){ tg.showAlert('–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ'); return; }
  btn.disabled=true; btn.textContent='–û—Ç–ø—Ä–∞–≤–∫–∞...';
  try{
    let imageUrl=null;
    if(file){
      const fileName=Date.now()+'.jpg';
      const { error: upError } = await db.storage.from('images').upload(fileName,file);
      if(upError) throw upError;
      const { data:{ publicUrl } } = db.storage.from('images').getPublicUrl(fileName);
      imageUrl=publicUrl;
    }

    const postData={
      username, content:text, user_id:userId,
      image_url:imageUrl, target_username:targetUser||null,
      parent_id:replyId, link_preview:null
    };

    const { error } = await db.from('posts').insert([postData]);
    if(error) throw error;
    closeModal(); await load();

  }catch(e){ console.error('–û—à–∏–±–∫–∞:',e); tg.showAlert('–û—à–∏–±–∫–∞: '+e.message); }
  finally{ btn.disabled=false; btn.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å'; }
}

// –£–¥–∞–ª–µ–Ω–∏–µ
async function del(id){
  tg.showConfirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?', async ok=>{
    if(!ok) return;
    try{ const { error }=await db.from('posts').delete().eq('id',id).eq('user_id',userId); if(error) throw error; await load(); }
    catch(e){ console.error('–û—à–∏–±–∫–∞:',e); tg.showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); }
  });
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ
function showImage(url){ document.getElementById('overlayImg').src=url; document.getElementById('overlay').classList.add('show'); }
function closeOverlay(){ document.getElementById('overlay').classList.remove('show'); }

// –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø–æ—Å—Ç–æ–º
function sharePost(id,text,image){
  const msg=encodeURIComponent(text); const img=encodeURIComponent(image||'');
  const tgUrl=`https://t.me/share/url?url=&text=${msg}`;
  const menu=`–í—ã–±–µ—Ä–∏—Ç–µ –∫—É–¥–∞ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è:\n1. Telegram\n2. Discord\n3. Instagram`;
  const choice=prompt(menu,'1');
  if(choice==='1'){ window.open(tgUrl,'_blank'); }
  else if(choice==='2'){ alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ Discord:\n'+text); }
  else if(choice==='3'){ alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ Instagram:\n'+text); }
}

// –°—Ç–∞—Ä—Ç
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',init); }
else{ init(); }
</script>
</body>
</html>
