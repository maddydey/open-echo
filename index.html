<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenEcho Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #0f0f10;
            --card-bg: rgba(28, 28, 30, 0.7);
            --accent: #0a84ff;
            --text-main: #ffffff;
            --text-dim: #8e8e93;
            --danger: #ff453a;
        }

        body { 
            background: var(--bg); 
            color: var(--text-main); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; 
            padding: 20px; 
            padding-bottom: 110px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        h2 {
            font-weight: 800;
            font-size: 28px;
            margin: 10px 0 24px 0;
            letter-spacing: -0.5px;
        }

        #feed {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .echo-card { 
            background: var(--card-bg); 
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 0; 
            border-radius: 24px; 
            position: relative; 
            border: 1px solid rgba(255, 255, 255, 0.08);
            overflow: hidden;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-content { padding: 16px 20px 20px 20px; }

        .author { 
            font-weight: 700; 
            color: var(--accent); 
            margin-bottom: 8px; 
            font-size: 14px;
        }

        .post-img { 
            width: 100%;
            display: block;
            object-fit: cover;
            max-height: 450px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .content { 
            font-size: 16px; 
            color: rgba(255, 255, 255, 0.95);
            word-wrap: break-word;
        }

        .delete-btn { 
            position: absolute; 
            top: 12px; 
            right: 12px; 
            background: rgba(255, 69, 58, 0.2); 
            border: none; 
            font-size: 14px; 
            cursor: pointer; 
            border-radius: 10px; 
            width: 30px; 
            height: 30px; 
            color: var(--danger);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            z-index: 10;
        }

        .btn-add { 
            position: fixed; 
            bottom: 30px; 
            right: 24px; 
            width: 60px; 
            height: 60px; 
            background: var(--accent); 
            border-radius: 20px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 30px; 
            color: white; 
            border: none; 
            box-shadow: 0 8px 25px rgba(10, 132, 255, 0.4); 
            z-index: 100;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-add:active { transform: scale(0.9) rotate(5deg); }

        #fileInput { display: none; }
        
        .loader { text-align: center; color: var(--text-dim); margin-top: 20px; font-size: 14px; }
    </style>
</head>
<body>

    <h2>OpenEcho üöÄ</h2>
    <div id="feed"><div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div></div>
    
    <input type="file" id="fileInput" accept="image/*">
    <button class="btn-add" onclick="document.getElementById('fileInput').click()">+</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.backgroundColor = '#0f0f10';
        tg.headerColor = '#0f0f10';

        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const SUPABASE_URL = 'https://xddulhzvzemmrhrsjfhb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j';
        // --------------------

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const currentUserId = tg.initDataUnsafe?.user?.id?.toString();

        async function loadEchos() {
            const { data, error } = await supabaseClient
                .from('posts')
                .select('*')
                .order('created_at', { ascending: false });
            
            const feed = document.getElementById('feed');
            if (error) {
                feed.innerHTML = `<div class="loader">–û—à–∏–±–∫–∞: ${error.message}</div>`;
                return;
            }

            if (data) {
                feed.innerHTML = '';
                data.forEach(post => {
                    const isMyPost = post.user_id === currentUserId;
                    const imgHtml = post.image_url ? `<img src="${post.image_url}" class="post-img" loading="lazy">` : '';
                    const deleteHtml = isMyPost ? `<button class="delete-btn" onclick="deleteEcho('${post.id}')">‚úï</button>` : '';

                    const card = document.createElement('div');
                    card.className = 'echo-card';
                    card.innerHTML = `
                        ${deleteHtml}
                        ${imgHtml}
                        <div class="card-content">
                            <div class="author">@${post.username || 'anon'}</div>
                            <div class="content">${post.content}</div>
                        </div>
                    `;
                    feed.appendChild(card);
                });
            }
        }

        document.getElementById('fileInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const text = prompt("–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å...");
            const username = tg.initDataUnsafe?.user?.username || "Guest";
            
            tg.MainButton.setText("–ü—É–±–ª–∏–∫–∞—Ü–∏—è...").show();

            let imageUrl = null;
            const fileName = `${Date.now()}_${file.name}`;

            // 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ
            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                .from('images')
                .upload(fileName, file);

            if (uploadData) {
                const { data: urlData } = supabaseClient.storage.from('images').getPublicUrl(fileName);
                imageUrl = urlData.publicUrl;
            }

            // 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞
            const { error: insertError } = await supabaseClient.from('posts').insert([{ 
                username: username, 
                content: text || "", 
                user_id: currentUserId,
                image_url: imageUrl
            }]);

            if (insertError) alert("–û—à–∏–±–∫–∞: " + insertError.message);
            
            tg.MainButton.hide();
            e.target.value = ''; // —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
            loadEchos();
        };

        async function deleteEcho(id) {
            if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?")) {
                const { error } = await supabaseClient.from('posts').delete().eq('id', id);
                if (!error) loadEchos();
            }
        }

        loadEchos();
    </script>
</body>
</html>
