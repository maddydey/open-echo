<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenEcho Elite</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #000000;
            --card-bg: rgba(28, 28, 30, 0.7);
            --accent: #0a84ff;
            --text-main: #ffffff;
            --text-dim: #8e8e93;
        }

        body { 
            background: var(--bg); color: var(--text-main); 
            font-family: -apple-system, system-ui, sans-serif; 
            margin: 0; padding: 20px; padding-bottom: 120px;
            overflow-x: hidden; -webkit-font-smoothing: antialiased;
        }

        /* –õ–ï–ù–¢–ê –ü–û–°–¢–û–í */
        #feed { display: flex; flex-direction: column; gap: 14px; }

        .echo-card { 
            background: var(--card-bg); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-radius: 28px; border: 1px solid rgba(255, 255, 255, 0.1); 
            opacity: 0; transform: translateY(25px);
            animation: emerge 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        @keyframes emerge { to { opacity: 1; transform: translateY(0); } }

        .post-img { width: 100%; border-radius: 28px 28px 0 0; cursor: pointer; display: block; transition: opacity 0.2s; }
        .post-img:active { opacity: 0.8; }
        .card-content { padding: 18px; }
        .author { color: var(--accent); font-weight: 700; font-size: 14px; margin-bottom: 6px; }

        /* –ö–ù–û–ü–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø */
        .btn-add { 
            position: fixed; bottom: 30px; right: 24px; 
            width: 64px; height: 64px; background: var(--accent); 
            border-radius: 50%; border: none; color: white; font-size: 32px;
            box-shadow: 0 12px 30px rgba(10, 132, 255, 0.4); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .btn-add:active { transform: scale(0.8) rotate(90deg); }

        /* –û–ö–ù–û –°–û–ó–î–ê–ù–ò–Ø (MODAL) */
        #modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            z-index: 1000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }
        .modal-window {
            background: #1c1c1e; width: 100%; max-width: 400px;
            border-radius: 32px; border: 1px solid rgba(255,255,255,0.15);
            padding: 24px; box-sizing: border-box;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            opacity: 0; transform: scale(0.9);
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* –û–ö–ù–û –ü–†–û–°–ú–û–¢–†–ê –§–û–¢–û */
        #imageOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            z-index: 2000; justify-content: center; align-items: center; padding: 20px;
        }
        .image-window { position: relative; max-width: 100%; animation: popIn 0.3s ease forwards; }
        .image-window img { width: 100%; max-height: 80vh; border-radius: 28px; box-shadow: 0 20px 40px rgba(0,0,0,0.8); }

        @keyframes popIn { to { opacity: 1; transform: scale(1); } }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        textarea { width: 100%; background: transparent; border: none; color: white; font-size: 18px; outline: none; resize: none; margin-bottom: 10px; }
        .input-field { width: 100%; background: rgba(255,255,255,0.06); border: none; border-radius: 14px; padding: 14px; color: white; margin-bottom: 15px; font-size: 15px; box-sizing: border-box; }
        #mediaPreview { width: 80px; height: 80px; margin-bottom: 15px; border-radius: 14px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1); }
        .loader { width: 20px; height: 20px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .reply-quote { background: rgba(255,255,255,0.05); border-left: 3px solid var(--accent); padding: 8px 12px; border-radius: 12px; margin-bottom: 12px; font-size: 13px; }
    </style>
</head>
<body>

    <h2 style="font-weight: 800; font-size: 28px; margin-bottom: 25px; letter-spacing: -1.5px;">OpenEcho</h2>
    <div id="feed"></div>

    <button class="btn-add" onclick="openModal()">+</button>

    <div id="modal" onclick="if(event.target == this) closeModal()">
        <div class="modal-window" onclick="event.stopPropagation()">
            <textarea id="postText" rows="4" placeholder="–¢–≤–æ–µ —ç—Ö–æ..."></textarea>
            
            <div id="mediaPreview" style="display:none">
                <img id="previewImg" style="width:100%; height:100%; object-fit:cover;">
                <div onclick="clearMedia()" style="position:absolute; top:4px; right:4px; background:#ff453a; color:white; border-radius:50%; width:20px; height:20px; text-align:center; line-height:20px; font-size:12px;">‚úï</div>
            </div>

            <input type="text" id="targetUser" class="input-field" placeholder="–ö–æ–º—É? @username (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
            <input type="file" id="fileInput" accept="image/*" onchange="updateFileName()" style="display:none">

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button onclick="document.getElementById('fileInput').click()" style="background:none; border:none; color:var(--accent); font-weight:600; font-size:16px;">üñº –§–æ—Ç–æ</button>
                <button id="submitBtn" onclick="sendPost()" style="background:var(--accent); color:white; border:none; padding:12px 28px; border-radius:18px; font-weight:700; min-width:110px; display:flex; justify-content:center;">
                    <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                </button>
            </div>
        </div>
    </div>

    <div id="imageOverlay" onclick="closeFullImage()">
        <div class="image-window" onclick="event.stopPropagation()">
            <img id="fullImage" src="">
            <div onclick="closeFullImage()" style="position:absolute; top:-55px; right:0; color:white; font-size:15px; font-weight:600; background:rgba(255,255,255,0.1); padding:10px 20px; border-radius:20px;">–ó–∞–∫—Ä—ã—Ç—å ‚úï</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const SUPABASE_URL = 'https://xddulhzvzemmrhrsjfhb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const currentUserId = tg.initDataUnsafe?.user?.id?.toString();

        function processContent(text) {
            if (!text) return { text: '', extra: '' };
            let extraHtml = '';
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/;
            
            const ytMatch = text.match(youtubeRegex);
            const allUrls = text.match(urlRegex);

            if (ytMatch) {
                extraHtml += `<div style="margin-top:12px; position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:18px; background:#000;"><iframe style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;" src="https://www.youtube.com/embed/${ytMatch[1]}" allowfullscreen></iframe></div>`;
            } else if (allUrls) {
                const url = allUrls[0];
                const displayTitle = url.split('/')[2].replace('www.', '');
                extraHtml += `<a href="${url}" target="_blank" style="text-decoration:none; margin-top:12px; display:flex; align-items:center; gap:10px; background:rgba(255,255,255,0.05); padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,0.1);"><span style="color:var(--accent); font-weight:700;">üîó ${displayTitle}</span></a>`;
            }

            const linkedText = text.replace(urlRegex, (url) => `<a href="${url}" target="_blank" style="color:var(--accent); text-decoration:none; font-weight:600;">—Å—Å—ã–ª–∫–∞</a>`);
            return { text: linkedText, extra: extraHtml };
        }

        async function loadEchos() {
            const { data } = await supabaseClient.from('posts').select('*').order('created_at', { ascending: false });
            const feed = document.getElementById('feed');
            if (!data) return;
            const myName = tg.initDataUnsafe?.user?.username;
            feed.innerHTML = '';

            data.forEach((post, index) => {
                const isMy = post.user_id === currentUserId;
                const isForMe = post.target_username && myName === post.target_username;
                const isPublic = !post.target_username;

                if (isPublic || isMy || isForMe) {
                    const card = document.createElement('div');
                    card.className = 'echo-card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    const processed = processContent(post.content);

                    card.innerHTML = `
                        ${post.image_url ? `<img src="${post.image_url}" class="post-img" onclick="openFullImage('${post.image_url}')">` : ''}
                        <div class="card-content">
                            ${post.parent_id ? renderReply(data, post.parent_id) : ''}
                            <div class="author">@${post.username} ${post.target_username ? 'üîí' : ''}</div>
                            <div style="font-size:16px; line-height:1.5; color:#eee;">${processed.text}</div>
                            ${processed.extra}
                            <div style="margin-top:14px; font-size:13px; color:var(--accent); font-weight:600; cursor:pointer;" onclick="openModal('${post.id}', '${post.username}')">–û—Ç–≤–µ—Ç–∏—Ç—å</div>
                        </div>`;
                    feed.appendChild(card);
                }
            });
        }

        function renderReply(all, pId) {
            const p = all.find(x => x.id === pId);
            if (!p) return '';
            const myName = tg.initDataUnsafe?.user?.username;
            const canSee = !p.target_username || p.user_id === currentUserId || myName === p.target_username;
            return `<div class="reply-quote"><div style="font-weight:700; color:var(--accent)">@${p.username}</div><div style="opacity:0.7; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${canSee ? (p.content || 'üñº –§–æ—Ç–æ') : 'üîí –°–µ–∫—Ä–µ—Ç–Ω–æ'}</div></div>`;
        }

        function openModal() { document.getElementById('modal').style.display = 'flex'; setTimeout(() => document.getElementById('postText').focus(), 150); }
        function closeModal() { document.getElementById('modal').style.display = 'none'; document.getElementById('postText').value = ''; clearMedia(); }
        function openFullImage(url) { document.getElementById('fullImage').src = url; document.getElementById('imageOverlay').style.display = 'flex'; document.body.style.overflow = 'hidden'; }
        function closeFullImage() { document.getElementById('imageOverlay').style.display = 'none'; document.body.style.overflow = 'auto'; }
        
        function updateFileName() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { document.getElementById('previewImg').src = e.target.result; document.getElementById('mediaPreview').style.display = 'block'; };
                reader.readAsDataURL(file);
            }
        }
        function clearMedia() { document.getElementById('fileInput').value = ""; document.getElementById('mediaPreview').style.display = 'none'; }

        async function sendPost() {
            const btn = document.getElementById('submitBtn');
            const text = document.getElementById('postText').value;
            const target = document.getElementById('targetUser').value.replace('@', '').trim();
            let file = document.getElementById('fileInput').files[0];
            if(!text && !file) return;

            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div>';
            let imageUrl = null;
            if (file) {
                const name = `${Date.now()}.jpg`;
                const { data } = await supabaseClient.storage.from('images').upload(name, file);
                if (data) imageUrl = supabaseClient.storage.from('images').getPublicUrl(name).data.publicUrl;
            }

            await supabaseClient.from('posts').insert([{
                username: tg.initDataUnsafe?.user?.username || "Guest",
                content: text, user_id: currentUserId, image_url: imageUrl, target_username: target || null
            }]);

            btn.disabled = false; btn.innerHTML = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            closeModal(); loadEchos();
        }

        loadEchos();
        supabaseClient.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, loadEchos).subscribe();
    </script>
</body>
</html>
