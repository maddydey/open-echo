<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenEcho One UI</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #f5f5f5;
  --card-bg: rgba(255,255,255,0.7);
  --text: #1a1a1a;
  --text-dim: #666;
  --accent: #1b6ef3;
  --border: rgba(0,0,0,0.08);
  --shadow: rgba(0,0,0,0.1);
}
[data-theme="dark"] {
  --bg: #0a0a0a;
  --card-bg: rgba(30,30,30,0.7);
  --text: #e5e5e5;
  --text-dim: #999;
  --accent: #5093ff;
  --border: rgba(255,255,255,0.1);
  --shadow: rgba(0,0,0,0.5);
}
* { box-sizing: border-box; margin:0; padding:0; }
body {
  font-family: -apple-system,sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 20px 20px 100px 20px;
  transition: background 0.3s,color 0.3s;
}

/* Header */
.header {
  display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;
}
h2 { font-size:28px; font-weight:700; }
.theme-btn {
  width:44px;height:44px;border-radius:50%;background:var(--card-bg);
  backdrop-filter:blur(20px); border:1px solid var(--border);
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  font-size:20px; box-shadow:0 4px 12px var(--shadow);
}

/* –ì–∞–ª–µ—Ä–µ—è */
#gallery { display:grid; grid-template-columns: repeat(auto-fill,minmax(120px,1fr)); gap:10px; margin-bottom:20px; }
.gallery-card { background: var(--card-bg); border-radius:12px; overflow:hidden; cursor:pointer; display:flex; flex-direction:column; }
.gallery-card img { width:100%; height:100px; object-fit:cover; }
.gallery-text { font-size:12px; padding:4px; text-overflow:ellipsis; white-space:nowrap; overflow:hidden; }

/* Feed */
#feed { display:flex; flex-direction:column; gap:16px; }
.card { background: var(--card-bg); backdrop-filter: blur(20px); border-radius:24px; padding:16px; border:1px solid var(--border); box-shadow:0 4px 20px var(--shadow); }
.author { color: var(--accent); font-weight:600; font-size:14px; margin-bottom:8px; }
.text { color: var(--text); line-height:1.4; font-size:14px; margin-bottom:8px; }
.img { width:100%; border-radius:12px; margin-bottom:8px; cursor:pointer; }

/* Reply */
.reply-box { background: var(--card-bg); border-left:3px solid var(--accent); padding:8px 10px; border-radius:12px; margin-bottom:8px; font-size:13px; border:1px solid var(--border);}
.reply-author { font-weight:600; color: var(--accent); margin-bottom:2px;}
.reply-text { font-size:13px; color: var(--text-dim);}

/* Actions */
.actions { display:flex; gap:12px; font-size:14px; margin-top:8px; padding-top:8px; border-top:1px solid var(--border); }
.btn { color: var(--accent); cursor:pointer; font-weight:500; }
.btn-del { color:#ff3b30; }
.btn-share { color:#34c759; }

/* Modal */
.add-btn { position:fixed; bottom:24px; right:24px; width:60px;height:60px;background:linear-gradient(135deg,var(--accent) 0%,#9055ff 100%);
  color:white;border:none;border-radius:50%; font-size:28px; cursor:pointer; box-shadow:0 8px 24px rgba(27,110,243,0.4); z-index:100; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
  z-index:200; align-items:center; justify-content:center; padding:20px; }
.modal.show { display:flex; }
.modal-content { background:var(--card-bg); backdrop-filter:blur(40px); border-radius:24px; padding:24px; width:100%; max-width:420px; border:1px solid var(--border); box-shadow:0 20px 60px var(--shadow); }
textarea { width:100%; border:1px solid var(--border); border-radius:16px; padding:14px; font-size:15px; resize:none; margin-bottom:12px; background:var(--card-bg); backdrop-filter:blur(20px); color:var(--text); }
textarea:focus { outline:none; border-color:var(--accent); }
input[type=text] { width:100%; border:1px solid var(--border); border-radius:16px; padding:12px 14px; font-size:14px; margin-bottom:16px; background:var(--card-bg); backdrop-filter:blur(20px); color:var(--text);}
input[type=text]:focus{outline:none;border-color:var(--accent);}
.modal-btns{display:flex; justify-content:space-between; align-items:center; gap:12px;}
.send-btn{background:linear-gradient(135deg,var(--accent) 0%,#9055ff 100%); color:white; border:none; padding:12px 28px; border-radius:16px; font-weight:600; font-size:15px; cursor:pointer;}
.send-btn:disabled{opacity:0.5;}
.file-btn{background:var(--card-bg); backdrop-filter:blur(20px); border:1px solid var(--border); color:var(--text); font-size:14px; cursor:pointer; padding:12px 20px; border-radius:16px; font-weight:500;}
.preview{width:80px; height:80px; position:relative; margin-bottom:12px; border-radius:12px; overflow:hidden;}
.preview img{width:100%; height:100%; object-fit:cover;}
.preview-close{position:absolute; top:-8px; right:-8px; background:#ff3b30; color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:14px;}

/* Overlay */
.overlay{display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); backdrop-filter:blur(20px); z-index:300; align-items:center; justify-content:center;}
.overlay.show{display:flex;}
.overlay img{max-width:90%; max-height:90%; border-radius:16px;}
</style>
</head>
<body data-theme="light">

<div class="header">
  <h2>OpenEcho üî•</h2>
  <button class="theme-btn" onclick="toggleTheme()" id="themeBtn">üåô</button>
</div>

<!-- –ì–∞–ª–µ—Ä–µ—è -->
<div id="gallery"></div>

<!-- Feed -->
<div id="feed"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>

<button class="add-btn" onclick="openModal()">+</button>

<!-- Modal -->
<div id="modal" class="modal" onclick="if(event.target==this) closeModal()">
  <div class="modal-content">
    <div id="replyBox" style="display:none" class="reply-box">
      <div class="reply-author" id="replyAuthor"></div>
      <div class="reply-text" id="replyText"></div>
    </div>

    <textarea id="txt" rows="4" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
    <div id="preview" class="preview" style="display:none">
      <img id="previewImg">
      <div class="preview-close" onclick="clearFile()">√ó</div>
    </div>
    <input type="text" id="target" placeholder="–ü—Ä–∏–≤–∞—Ç–Ω–æ –¥–ª—è @username">
    <div class="modal-btns">
      <button class="file-btn" onclick="document.getElementById('file').click()">üì∑ –§–æ—Ç–æ</button>
      <input type="file" id="file" hidden accept="image/*" onchange="showPreview()">
      <button class="send-btn" id="sendBtn" onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Overlay -->
<div id="overlay" class="overlay" onclick="closeOverlay()">
  <img id="overlayImg">
</div>

<script>
// Telegram WebApp
const tg = window.Telegram.WebApp;
tg.expand();

// Supabase
const SUPABASE_URL = 'https://xddulhzvzemmrhrsjfhb.supabase.co';
const SUPABASE_KEY = 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j';
let db=null, userId=null, username=null, replyId=null;

// Theme
function toggleTheme(){
  const body=document.body, btn=document.getElementById('themeBtn'), current=body.getAttribute('data-theme');
  if(current==='light'){body.setAttribute('data-theme','dark'); btn.textContent='‚òÄÔ∏è'; localStorage.setItem('theme','dark');}
  else{body.setAttribute('data-theme','light'); btn.textContent='üåô'; localStorage.setItem('theme','light');}
}
const savedTheme = localStorage.getItem('theme') || 'light';
document.body.setAttribute('data-theme', savedTheme);
if(savedTheme==='dark'){document.getElementById('themeBtn').textContent='‚òÄÔ∏è';}

// Esc
function esc(str){ const div=document.createElement('div'); div.textContent=str||''; return div.innerHTML; }

// Init
async function init(){
  try{
    const user=tg.initDataUnsafe?.user;
    if(!user){userId='test123'; username='TestUser';}
    else{userId=user.id.toString(); username=user.username||('User'+user.id);}
    if(SUPABASE_URL.includes('your-project')) throw new Error('–£–∫–∞–∂–∏—Ç–µ SUPABASE_URL –∏ SUPABASE_KEY');
    db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    await load();
    db.channel('posts-channel')
      .on('postgres_changes',{event:'*',schema:'public',table:'posts'},()=>load())
      .subscribe();
  }catch(e){
    console.error(e); document.getElementById('feed').innerHTML='<div class="error">–û—à–∏–±–∫–∞: '+e.message+'</div>';
  }
}

// Load posts
async function load(){
  try{
    const {data,error}=await db.from('posts').select('*').order('created_at',{ascending:false}).limit(100);
    if(error)throw error;
    if(!data||data.length===0){document.getElementById('feed').innerHTML='<div class="empty">üìù<br><br>–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤<br>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>'; return;}
    
    // –ì–∞–ª–µ—Ä–µ—è —Å–ª—É—á–∞–π–Ω—ã—Ö 5 –ø–æ—Å—Ç–æ–≤
    const galleryDiv=document.getElementById('gallery');
    galleryDiv.innerHTML='';
    const shuffled=[...data].sort(()=>Math.random()-0.5).slice(0,5);
    shuffled.forEach(p=>{
      if(!p.image_url)return;
      const div=document.createElement('div'); div.className='gallery-card';
      div.innerHTML=`<img src="${p.image_url}" onclick="showImage('${p.image_url}')"><div class="gallery-text">${esc((p.content||'').substring(0,50))}</div>`;
      galleryDiv.appendChild(div);
    });

    // Feed
    const feed=document.getElementById('feed'); feed.innerHTML='';
    data.forEach(post=>{
      const isMy=post.user_id===userId;
      const isForMe=post.target_username===username;
      if(post.target_username && !isMy && !isForMe) return;
      const card=document.createElement('div'); card.className='card';
      let html='';
      if(post.parent_id){
        const parent=data.find(p=>p.id===post.parent_id);
        if(parent){
          html+=`<div class="reply-box"><div class="reply-author">@${esc(parent.username)}</div><div class="reply-text">${esc(parent.content||'üì∑')}</div></div>`;
        }
      }
      const lock=post.target_username?' üîí':'';
      html+=`<div class="author">@${esc(post.username)}${lock}</div>`;
      if(post.image_url){html+=`<img class="img" src="${post.image_url}" onclick="showImage('${post.image_url}')" loading="lazy">`;}
      if(post.content){html+=`<div class="text">${esc(post.content)}</div>`;}
      html+=`<div class="actions">
        <span class="btn" onclick="reply('${post.id}','${esc(post.username)}','${esc((post.content||'').substring(0,40))}')">üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å</span>
        <span class="btn-share" onclick="sharePost('${esc(post.content||'')}', '${post.image_url||''}')">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
      `;
      if(isMy){html+=`<span class="btn btn-del" onclick="del('${post.id}')">üóë –£–¥–∞–ª–∏—Ç—å</span>`;}
      html+='</div>'; card.innerHTML=html; feed.appendChild(card);
    });
  }catch(e){console.error(e);document.getElementById('feed').innerHTML='<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';}
}

// Modal
function openModal(){document.getElementById('modal').classList.add('show');}
function closeModal(){
  document.getElementById('modal').classList.remove('show');
  setTimeout(()=>{
    document.getElementById('txt').value='';
    document.getElementById('target').value='';
    document.getElementById('replyBox').style.display='none';
    clearFile(); replyId=null;
  },300);
}
function reply(id,user,text){
  replyId=id;
  document.getElementById('replyAuthor').textContent='@'+user;
  document.getElementById('replyText').textContent=text+'...';
  document.getElementById('replyBox').style.display='block';
  openModal();
}

// File preview
function showPreview(){
  const file=document.getElementById('file').files[0]; if(!file) return;
  if(file.size>5*1024*1024){tg.showAlert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 5–ú–ë)'); document.getElementById('file').value=''; return;}
  const reader=new FileReader();
  reader.onload=e=>{document.getElementById('previewImg').src=e.target.result; document.getElementById('preview').style.display='block';};
  reader.readAsDataURL(file);
}
function clearFile(){document.getElementById('file').value=''; document.getElementById('preview').style.display='none';}

// Send
async function send(){
  const btn=document.getElementById('sendBtn');
  const text=document.getElementById('txt').value.trim();
  const targetUser=document.getElementById('target').value.replace('@','').trim();
  const file=document.getElementById('file').files[0];
  if(!text&&!file){tg.showAlert('–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ'); return;}
  btn.disabled=true; btn.textContent='–û—Ç–ø—Ä–∞–≤–∫–∞...';
  try{
    let imageUrl=null;
    if(file){
      const fileName=Date.now()+'.jpg';
      const {error:upError}=await db.storage.from('images').upload(fileName,file);
      if(upError)throw upError;
      const {data:{publicUrl}}=db.storage.from('images').getPublicUrl(fileName);
      imageUrl=publicUrl;
    }
    const postData={username,content:text,user_id:userId,image_url:imageUrl,target_username:targetUser||null,parent_id:replyId};
    const {error}=await db.from('posts').insert([postData]);
    if(error)throw error;
    closeModal(); await load();
  }catch(e){console.error(e); tg.showAlert('–û—à–∏–±–∫–∞: '+e.message);}
  finally{btn.disabled=false; btn.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å';}
}

// Delete
async function del(id){
  tg.showConfirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?', async ok=>{
    if(!ok)return;
    try{
      const {error}=await db.from('posts').delete().eq('id',id).eq('user_id',userId);
      if(error)throw error;
      await load();
    }catch(e){console.error(e); tg.showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');}
  });
}

// Overlay
function showImage(url){document.getElementById('overlayImg').src=url; document.getElementById('overlay').classList.add('show');}
function closeOverlay(){document.getElementById('overlay').classList.remove('show');}

// Share post
function sharePost(text,img){
  const tgUrl='https://t.me/share/url?url=&text='+encodeURIComponent(text);
  const menu=`–í—ã–±–µ—Ä–∏—Ç–µ –∫—É–¥–∞ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è:
1. Telegram
2. Discord
3. Instagram`;
  const choice=prompt(menu,'1');
  if(choice==='1'){ window.open(tgUrl,'_blank'); }
  else if(choice==='2'){ alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ Discord:\n'+text); }
  else if(choice==='3'){ alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ Instagram:\n'+text); }
}

// Start
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);}
else{init();}
</script>
</body>
</html>
