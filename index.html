<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OpenEcho Pro Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #000000;
            --card-bg: rgba(28, 28, 30, 0.6);
            --accent: #0a84ff;
            --text: #ffffff;
            --border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            overflow-x: hidden;
            display: flex;
            justify-content: center;
        }

        /* –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .app-wrapper {
            display: flex;
            width: 100%;
            max-width: 1200px;
            min-height: 100vh;
            padding: 20px;
            gap: 20px;
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è iPad */
        .sidebar {
            width: 280px;
            position: sticky;
            top: 20px;
            height: calc(100vh - 40px);
            display: none; /* –°–∫—Ä—ã—Ç–∞ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö */
            flex-direction: column;
            gap: 20px;
        }

        @media (min-width: 900px) {
            .sidebar { display: flex; }
        }

        .side-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 24px;
            border: 1px solid var(--border);
        }

        /* –õ–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π */
        .main-content {
            flex: 1;
            max-width: 100%;
        }

        #feed { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 16px; 
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ—Å—Ç–∞ */
        .card {
            background: var(--card-bg); 
            backdrop-filter: blur(30px); 
            -webkit-backdrop-filter: blur(30px);
            border-radius: 28px; 
            padding: 20px; 
            border: 1px solid var(--border); 
            height: fit-content;
            transition: transform 0.2s ease;
        }

        .card:active { transform: scale(0.98); }

        .post-img { 
            width: calc(100% + 40px); 
            margin: -20px -20px 15px -20px; 
            max-height: 400px; 
            object-fit: cover; 
            border-radius: 28px 28px 0 0;
        }

        .author { 
            color: var(--accent); 
            font-weight: 700; 
            font-size: 14px; 
            margin-bottom: 8px; 
            display: flex; 
            align-items: center; 
            gap: 5px;
        }

        /* –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞ */
        .add-btn { 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            width: 64px; 
            height: 64px; 
            background: var(--accent); 
            border-radius: 50%; 
            border: none; 
            color: white; 
            font-size: 32px; 
            z-index: 999; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 8px 25px rgba(10,132,255,0.4); 
            cursor: pointer;
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        .modal-content { 
            background: #1c1c1e; 
            border-radius: 35px; 
            padding: 30px; 
            width: 100%; 
            max-width: 500px; 
            border: 1px solid var(--border); 
        }

        textarea { 
            width: 100%; background: transparent; border: none; color: white; 
            font-size: 18px; outline: none; resize: none; min-height: 100px;
        }

        .reply-box { 
            background: rgba(255,255,255,0.05); 
            padding: 12px; 
            border-radius: 15px; 
            border-left: 4px solid var(--accent);
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <div class="app-wrapper">
        <div class="sidebar">
            <div class="side-card">
                <h2 id="userName" style="font-size: 20px; margin-bottom: 5px;">–ü—Ä–∏–≤–µ—Ç!</h2>
                <p style="opacity: 0.5; font-size: 14px;">–†–∞–¥—ã –≤–∏–¥–µ—Ç—å —Ç–µ–±—è –≤ OpenEcho Pro</p>
            </div>
            <div class="side-card">
                <p style="font-weight: 700; color: var(--accent);">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p>
                <div style="margin-top:10px; font-size: 14px; opacity: 0.8;">
                    –ü–æ—Å—Ç–æ–≤ –≤ –ª–µ–Ω—Ç–µ: <span id="count">0</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div id="feed"></div>
        </div>
    </div>

    <button class="add-btn" onclick="openModal()">+</button>

    <div id="modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(20px); z-index:1000; align-items:center; justify-content:center; padding:20px;" onclick="if(event.target==this) closeModal()">
        <div class="modal-content">
            <div id="replyPreview" style="display:none" class="reply-box">
                <div id="replyAuthor" style="font-weight:700; color:var(--accent)"></div>
                <div id="replyText" style="font-size:13px; opacity:0.7"></div>
            </div>
            <textarea id="txt" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..."></textarea>
            <div id="mediaPreview" style="display:none; margin-bottom:15px;"><img id="previewImg" style="width:80px; height:80px; border-radius:12px; object-fit:cover;"></div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button onclick="document.getElementById('fileInput').click()" style="background:none; border:none; color:var(--accent); font-weight:600;">üì∑ –§–æ—Ç–æ</button>
                <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile()">
                <button id="sendBtn" onclick="send()" style="background:var(--accent); color:white; border:none; padding:12px 25px; border-radius:15px; font-weight:700;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

<script>
// –¢–£–¢ –í–°–¢–ê–í–õ–Ø–ï–ú –í–ï–°–¨ JS –ò–ó –ü–†–û–®–õ–û–ì–û –û–¢–í–ï–¢–ê (Supabase init, load, send, del)
// –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –≤ —Ñ—É–Ω–∫—Ü–∏—é load:
// document.getElementById('count').innerText = data.length;
// document.getElementById('userName').innerText = '–ü—Ä–∏–≤–µ—Ç, @' + myUsername + '!';
</script>

<script>
// --- –ü–û–í–¢–û–† JS –õ–û–ì–ò–ö–ò –î–õ–Ø –†–ê–ë–û–¢–´ ---
const tg = window.Telegram.WebApp;
const haptic = tg.HapticFeedback;
tg.expand();

const SUPABASE_URL = 'https://xddulhzvzemmrhrsjfhb.supabase.co';
const SUPABASE_KEY = 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const myId = tg.initDataUnsafe?.user?.id?.toString() || 'guest';
const myUsername = tg.initDataUnsafe?.user?.username || 'Guest';
let replyId = null;

async function load() {
    const { data, error } = await db.from('posts').select('*').order('created_at', { ascending: false });
    if (error) return;
    
    document.getElementById('count').innerText = data.length;
    document.getElementById('userName').innerText = '–ü—Ä–∏–≤–µ—Ç, @' + myUsername + '!';
    
    const feed = document.getElementById('feed');
    feed.innerHTML = '';
    
    data.forEach((post) => {
        const card = document.createElement('div');
        card.className = 'card';
        
        let replyHtml = '';
        if (post.parent_id) {
            const parent = data.find(p => p.id === post.parent_id);
            if (parent) replyHtml = `<div class="reply-box"><b>@${parent.username}</b>: ${parent.content?.substring(0,30)}...</div>`;
        }

        card.innerHTML = `
            ${post.image_url ? `<img src="${post.image_url}" class="post-img" loading="lazy">` : ''}
            <div class="author">@${post.username}</div>
            ${replyHtml}
            <div class="text">${post.content || ''}</div>
            <div style="margin-top:15px; display:flex; gap:15px; font-size:13px; font-weight:700;">
                <span style="color:var(--accent); cursor:pointer;" onclick="setupReply('${post.id}','${post.username}','${(post.content||'').substring(0,20)}')">üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å</span>
                ${post.user_id === myId ? `<span style="color:#ff453a; cursor:pointer;" onclick="del('${post.id}')">üóë –£–¥–∞–ª–∏—Ç—å</span>` : ''}
            </div>
        `;
        feed.appendChild(card);
    });
}

// (–§—É–Ω–∫—Ü–∏–∏ send, del, openModal, closeModal, handleFile –æ—Å—Ç–∞—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º–∏)
function openModal() { document.getElementById('modal').style.display = 'flex'; haptic.impactOccurred('light'); }
function closeModal() { document.getElementById('modal').style.display = 'none'; replyId = null; }
function setupReply(id, user, text) {
    replyId = id;
    document.getElementById('replyAuthor').innerText = '@' + user;
    document.getElementById('replyText').innerText = text + '...';
    document.getElementById('replyPreview').style.display = 'block';
    openModal();
}
async function send() {
    const txt = document.getElementById('txt').value.trim();
    if (!txt) return;
    const btn = document.getElementById('sendBtn');
    btn.disabled = true;
    await db.from('posts').insert([{ content: txt, username: myUsername, user_id: myId, parent_id: replyId }]);
    haptic.notificationOccurred('success');
    closeModal(); load(); btn.disabled = false;
}
async function del(id) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { await db.from('posts').delete().eq('id', id); load(); } }

load();
db.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, load).subscribe();
</script>
</body>
</html>
