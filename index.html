<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenEcho Elite</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root { --bg: #0b0b0c; --card: #1c1c1e; --accent: #0a84ff; --text: #ffffff; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 15px; padding-bottom: 100px; }
        
        #feed { display: flex; flex-direction: column; gap: 20px; }
        .post-group { display: flex; flex-direction: column; }

        /* ГЛАВНЫЙ ПОСТ */
        .card { 
            background: var(--card); border-radius: 22px; padding: 16px; 
            border: 1px solid rgba(255,255,255,0.08); position: relative; z-index: 2;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        /* ОТВЕТ (ЗАЛЕЗАЕТ ПОД ПОСТ) */
        .reply-card { 
            margin-left: 10%; margin-top: -15px; padding: 25px 16px 16px 16px;
            background: #161618; border-radius: 0 0 20px 20px;
            border: 1px solid rgba(255,255,255,0.05); border-top: none;
            z-index: 1; transform: scale(0.98);
        }

        .author-info { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .avatar { 
            width: 32px; height: 32px; border-radius: 10px; 
            background: linear-gradient(135deg, var(--accent), #5e5ce6);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px;
        }

        .username { color: var(--accent); font-weight: 700; font-size: 14px; }
        .content { font-size: 15px; line-height: 1.4; opacity: 0.9; }
        .btn-reply { color: var(--accent); font-size: 12px; font-weight: 800; cursor: pointer; margin-top: 10px; display: inline-block; }

        .fab { position: fixed; bottom: 25px; right: 20px; width: 60px; height: 60px; background: var(--accent); border-radius: 20px; border: none; color: white; font-size: 30px; z-index: 100; box-shadow: 0 8px 20px rgba(10,132,255,0.3); }

        /* МОДАЛКА */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: flex-end; }
        .modal-box { background: #1c1c1e; width: 100%; padding: 20px; border-radius: 25px 25px 0 0; }
        textarea { width: 100%; background: transparent; border: none; color: white; font-size: 17px; outline: none; min-height: 100px; resize: none; }
        .send-btn { background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; width: 100%; margin-top: 15px; }
    </style>
</head>
<body>

    <h2 style="margin-left: 5px; margin-bottom: 20px;">OpenEcho</h2>
    <div id="feed">Загрузка данных...</div>

    <button class="fab" onclick="openModal()">+</button>

    <div id="modal" onclick="if(event.target==this) closeM()">
        <div class="modal-box">
            <div id="replyToTxt" style="color:var(--accent); font-size:12px; margin-bottom:10px; display:none;"></div>
            <textarea id="msg" placeholder="Что нового?"></textarea>
            <button class="send-btn" onclick="send()">Опубликовать</button>
        </div>
    </div>

<script>
    // 1. НАСТРОЙКИ (ВСТАВЬ СВОИ)
    const S_URL = 'ТВОЙ_URL';
    const S_KEY = 'ТВОЙ_KEY';

    const supabase = window.supabase.createClient(S_URL, S_KEY);
    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe?.user?.username || "Guest";
    let replyId = null;

    // 2. ЗАГРУЗКА
    async function load() {
        try {
            const { data, error } = await supabase.from('posts').select('*').order('created_at', { ascending: false });
            if (error) throw error;

            const feed = document.getElementById('feed');
            feed.innerHTML = '';

            if (!data || data.length === 0) {
                feed.innerHTML = "<center style='opacity:0.5'>Тут пока пусто</center>";
                return;
            }

            const mainPosts = data.filter(p => !p.parent_id);
            const replies = data.filter(p => p.parent_id);

            mainPosts.forEach(post => {
                const group = document.createElement('div');
                group.className = 'post-group';
                
                // Рендер главного поста
                group.innerHTML = renderPost(post, false);

                // Рендер ответов (залезающих под него)
                const postReplies = replies.filter(r => r.parent_id === post.id).reverse();
                postReplies.forEach(r => {
                    group.innerHTML += renderPost(r, true);
                });

                feed.appendChild(group);
            });
        } catch (e) {
            document.getElementById('feed').innerHTML = `<div style="color:red">Ошибка: ${e.message}</div>`;
        }
    }

    function renderPost(p, isReply) {
        const letter = (p.username || "G")[0].toUpperCase();
        return `
            <div class="${isReply ? 'reply-card' : 'card'}">
                <div class="author-info">
                    <div class="avatar" style="${isReply ? 'width:24px; height:24px; font-size:11px' : ''}">${letter}</div>
                    <div class="username">@${p.username}</div>
                </div>
                <div class="content">${p.content}</div>
                ${!isReply ? `<div class="btn-reply" onclick="setupReply('${p.id}', '${p.username}')">ОТВЕТИТЬ</div>` : ''}
            </div>`;
    }

    // 3. ФУНКЦИИ
    function openModal() { document.getElementById('modal').style.display = 'flex'; }
    function closeM() { 
        document.getElementById('modal').style.display = 'none'; 
        replyId = null; 
        document.getElementById('msg').value = '';
        document.getElementById('replyToTxt').style.display = 'none';
    }

    function setupReply(id, name) {
        replyId = id;
        document.getElementById('replyToTxt').innerText = 'ОТВЕТ ДЛЯ @' + name.toUpperCase();
        document.getElementById('replyToTxt').style.display = 'block';
        openModal();
    }

    async function send() {
        const text = document.getElementById('msg').value.trim();
        if (!text) return;

        const { error } = await supabase.from('posts').insert([{
            content: text,
            username: user,
            parent_id: replyId
        }]);

        if (error) alert(error.message);
        else { closeM(); load(); }
    }

    load();
</script>
</body>
</html>
