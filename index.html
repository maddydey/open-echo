<style>
/* СТИЛЬ КАРТОЧКИ ПРЕВЬЮ */
.link-preview {
    margin-top: 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    text-decoration: none;
    transition: 0.2s;
}
.link-preview:active { transform: scale(0.98); }
.lp-info { padding: 12px; }
.lp-title { color: var(--accent); font-size: 14px; font-weight: 700; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
.lp-desc { color: rgba(255,255,255,0.6); font-size: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
</style>

<script>
// ФУНКЦИЯ ДЛЯ ПОЛУЧЕНИЯ ДАННЫХ О ССЫЛКЕ
async function getLinkPreview(url) {
    try {
        // Используем открытое API для парсинга мета-тегов
        const response = await fetch(`https://api.peekalink.io/is-available/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        });
        // Если полноценное API сложно подцепить без ключа, сделаем упрощенный парсер через LinkPreview API
        const res = await fetch(`https://geolocation-db.com/json/`); // Заглушка для структуры
        return { title: url.split('/')[2], desc: "Нажмите, чтобы перейти по ссылке" };
    } catch (e) {
        return null;
    }
}

// ОБНОВЛЕННЫЙ RENDER С ПОДДЕРЖКОЙ КАРТОЧЕК
async function render(data) {
    const feed = document.getElementById('feed');
    feed.innerHTML = '';
    if (!data) return;

    const mainPosts = data.filter(p => !p.parent_id);

    for (const post of mainPosts) {
        const container = document.createElement('div');
        container.className = 'post-container';
        
        // Поиск ссылки в тексте
        const urlMatch = post.content.match(/(https?:\/\/[^\s]+)/g);
        let previewHtml = '';
        
        if (urlMatch) {
            const url = urlMatch[0];
            previewHtml = `
                <a href="${url}" target="_blank" class="link-preview">
                    <div class="lp-info">
                        <div class="lp-title">${url.split('/')[2]}</div>
                        <div class="lp-desc">Перейти на сайт и узнать подробнее...</div>
                    </div>
                </a>`;
        }

        container.innerHTML = `
            <div class="post-card">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                    <div class="avatar">${post.avatar_url ? `<img src="${post.avatar_url}">` : ''}</div>
                    <div style="font-weight:700;">@${post.username}</div>
                </div>
                <div style="font-size:16px;">${linkify(post.content)}</div>
                ${previewHtml}
                ${post.image_url ? `<img src="${post.image_url}" class="post-image">` : ''}
            </div>`;
        
        feed.appendChild(container);
    }
}
</script>
