<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ECHO Premium Evolution</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root { 
    --bg: #000; 
    --glass: rgba(255, 255, 255, 0.08);
    --glass-border: rgba(255, 255, 255, 0.12);
    --accent: #0a84ff;
    --gold: #ffd700;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { font-family: -apple-system, system-ui, sans-serif; background: #000; color: #fff; height: 100vh; overflow: hidden; }

#app { 
    height: 100vh; overflow-y: auto; 
    padding: calc(env(safe-area-inset-top) + 20px) 16px 220px;
    scrollbar-width: none;
}
#app::-webkit-scrollbar { display: none; }

.post-group { margin-bottom: 50px; position: relative; }

/* –û–°–ù–û–í–ù–ê–Ø –ö–ê–†–¢–û–ß–ö–ê */
.card { 
    background: var(--glass); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
    border: 1px solid var(--glass-border); border-radius: 30px; padding: 20px;
    z-index: 5; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

/* –°–ò–ù–Ø–Ø –û–ë–í–û–î–ö–ê */
.avatar-box {
    width: 48px; height: 48px; border-radius: 50%;
    border: 2px solid var(--accent);
    box-shadow: 0 0 15px rgba(10, 132, 255, 0.4);
    overflow: hidden; flex-shrink: 0;
}
.avatar-box img { width: 100%; height: 100%; object-fit: cover; }

/* –£–õ–£–ß–®–ï–ù–ù–´–ï –û–¢–í–ï–¢–´ */
.replies-container { 
    margin: 12px 0 0 30px; 
    display: flex; flex-direction: column; gap: 8px;
}
.reply-card {
    background: rgba(255,255,255,0.04);
    border-left: 3px solid var(--accent);
    border-radius: 12px 18px 18px 12px;
    padding: 12px 16px; font-size: 14px;
    position: relative;
}
.reply-card b { color: var(--accent); font-size: 12px; display: block; margin-bottom: 4px; }

/* –£–ú–ù–´–ï –°–°–´–õ–ö–ò –° –ü–†–ï–í–¨–Æ */
.link-stack { display: flex; flex-direction: column; gap: 10px; margin-top: 18px; }

.smart-link {
    background: rgba(30, 30, 35, 0.6);
    border: 1px solid var(--glass-border);
    border-radius: 20px; overflow: hidden;
    display: flex; align-items: stretch; height: 70px;
    transition: 0.3s;
}
.link-preview-img {
    width: 80px; height: 100%; background: #222;
    object-fit: cover; border-right: 1px solid var(--glass-border);
}
.link-info {
    padding: 10px 14px; display: flex; flex-direction: column; justify-content: center;
    overflow: hidden; flex: 1;
}
.link-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
.link-logo { width: 16px; height: 16px; border-radius: 4px; }
.link-title { font-weight: 800; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.link-desc { font-size: 11px; opacity: 0.5; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* –ò–°–¢–û–ß–ù–ò–ö */
.src-tag {
    background: var(--accent); color: #fff;
    padding: 4px 10px; border-radius: 8px;
    font-size: 10px; font-weight: 900;
    display: inline-block; margin-bottom: 12px;
}

/* UI */
.nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(15,15,15,0.8); backdrop-filter: blur(25px); padding: 8px; border-radius: 100px; display: flex; border: 1px solid var(--glass-border); z-index: 1000; }
.nav-item { width: 60px; height: 50px; display: flex; align-items: center; justify-content: center; opacity: 0.3; font-size: 24px; }
.nav-item.active { opacity: 1; }
.fab { position: fixed; bottom: 105px; right: 25px; width: 64px; height: 64px; background: #fff; border-radius: 50%; border: none; font-size: 32px; z-index: 1100; box-shadow: 0 8px 25px rgba(0,0,0,0.4); }

.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:5000; align-items:flex-end; }
.sheet { width:100%; background:#111; border-radius:35px 35px 0 0; padding:25px; border-top:1px solid var(--glass-border); }
.inp { width:100%; background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); border-radius: 18px; color:#fff; padding:16px; margin-bottom:12px; }
</style>
</head>
<body>

<div id="app">
    <div id="header" style="text-align:center; padding-bottom:30px; font-size:32px; font-weight:900; letter-spacing:-1px;">ECHO</div>
    <div id="feed"></div>
</div>

<div class="nav">
    <div class="nav-item active" onclick="location.reload()">üè†</div>
    <div class="nav-item" onclick="tg.showAlert('Profile')">üë§</div>
</div>
<button class="fab" onclick="openM()">+</button>

<div id="modal" class="modal" onclick="if(event.target==this) closeM()">
    <div class="sheet">
        <textarea id="txt" class="inp" style="height:120px;" placeholder="–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞..."></textarea>
        <input id="linkInp" class="inp" placeholder="–°—Å—ã–ª–∫–∞ (https://...)">
        <input id="srcInp" class="inp" placeholder="–ò—Å—Ç–æ—á–Ω–∏–∫">
        <button id="sendBtn" style="width:100%; padding:20px; border-radius:20px; border:none; background:#fff; font-weight:900;" onclick="send()">PUBLISH</button>
    </div>
</div>

<script>
const tg = window.Telegram.WebApp;
const db = supabase.createClient('https://xddulhzvzemmrhrsjfhb.supabase.co', 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j');

const myId = tg.initDataUnsafe?.user?.id?.toString() || 'guest';
const myName = tg.initDataUnsafe?.user?.username || 'Guest';
const myAvatar = tg.initDataUnsafe?.user?.photo_url || '';

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫—Ä–∞—Å–∏–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Å—ã–ª–∫–∏
function getLinkCard(url) {
    if(!url) return '';
    try {
        const domain = new URL(url).hostname.replace('www.', '');
        const logo = `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
        // –ú–∏–Ω–∏-–ø—Ä–µ–≤—å—é —á–µ—Ä–µ–∑ microlink (—Å–∫—Ä–∏–Ω—à–æ—Ç —Å–∞–π—Ç–∞)
        const preview = `https://api.microlink.io/?url=${encodeURIComponent(url)}&screenshot=true&embed=screenshot.url`;
        
        return `
        <div class="smart-link" onclick="event.stopPropagation(); tg.openLink('${url}')">
            <img src="${preview}" class="link-preview-img" onerror="this.style.display='none'">
            <div class="link-info">
                <div class="link-header">
                    <img src="${logo}" class="link-logo">
                    <span class="link-title">${domain}</span>
                </div>
                <div class="link-desc">–û—Ç–∫—Ä—ã—Ç—å –∑–∞—â–∏—â–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É</div>
            </div>
        </div>`;
    } catch(e) { return ''; }
}

async function load() {
    const { data } = await db.from('posts').select('*').order('created_at', { ascending: false });
    if(data) render(data);
}

function render(data) {
    const feed = document.getElementById('feed');
    feed.innerHTML = '';

    const mains = data.filter(p => !p.parent_id);
    mains.forEach(p => {
        const group = document.createElement('div');
        group.className = 'post-group';

        let content = p.content;
        let srcTag = '';
        if(content.includes('||SRC||')) {
            const parts = content.split('||SRC||');
            content = parts[0];
            srcTag = `<div class="src-tag">${parts[1].trim()}</div>`;
        }

        // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—ç–∫ —Å—Å—ã–ª–æ–∫
        let linksHtml = getLinkCard(p.track_url);
        const inlineLinks = content.match(/(https?:\/\/[^\s]+)/g);
        if(inlineLinks) inlineLinks.forEach(url => { if(url !== p.track_url) linksHtml += getLinkCard(url); });

        // –û—Ç–≤–µ—Ç—ã
        const replies = data.filter(r => r.parent_id === p.id);
        const repsHtml = replies.length ? `
            <div class="replies-container">
                ${replies.map(r => `
                    <div class="reply-card">
                        <b>@${r.username}</b>
                        ${r.content.split('||SRC||')[0]}
                    </div>
                `).join('')}
            </div>` : '';

        group.innerHTML = `
            <div class="card" onclick="openM('${p.id}')">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:15px;">
                    <div class="avatar-box"><img src="${p.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"></div>
                    <div style="flex:1">
                        <div style="font-weight:900; font-size:16px;">@${p.username}</div>
                        <div style="font-size:10px; opacity:0.4;">ECHO NETWORK</div>
                    </div>
                    ${p.user_id === myId ? `<div onclick="event.stopPropagation(); del('${p.id}')" style="opacity:0.2;">‚úï</div>` : ''}
                </div>
                ${srcTag}
                <div style="font-size:16px; line-height:1.5;">${content}</div>
                <div class="link-stack">${linksHtml}</div>
            </div>
            <div style="position:absolute; bottom:-10px; left:20px; right:20px; height:30px; background:rgba(255,255,255,0.02); border:1px solid var(--glass-border); border-top:none; border-radius:0 0 20px 20px; z-index:1;"></div>
            ${repsHtml}
        `;
        feed.appendChild(group);
    });
}

let replyId = null;
function openM(id=null) { replyId=id; document.getElementById('modal').style.display='flex'; }
function closeM() { document.getElementById('modal').style.display='none'; }

async function send() {
    let t = document.getElementById('txt').value;
    const l = document.getElementById('linkInp').value;
    const s = document.getElementById('srcInp').value;
    if(!t) return;
    if(s) t += " ||SRC|| " + s;

    await db.from('posts').insert([{ content: t, username: myName, user_id: myId, avatar_url: myAvatar, track_url: l, parent_id: replyId }]);
    closeM(); load();
    document.getElementById('txt').value=''; document.getElementById('linkInp').value=''; document.getElementById('srcInp').value='';
}

async function del(id) { if(confirm('Del?')) { await db.from('posts').delete().eq('id', id); load(); } }
window.onload = () => { tg.expand(); load(); };
</script>
</body>
</html>
