<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>OpenEcho Link Pro</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #f5f5f5;
  --card-bg: rgba(255,255,255,0.8);
  --text: #1a1a1a;
  --accent: #1b6ef3;
  --border: rgba(0,0,0,0.08);
  --shadow: rgba(0,0,0,0.05);
}

[data-theme="dark"] {
  --bg: #000000;
  --card-bg: rgba(28,28,30,0.8);
  --text: #ffffff;
  --accent: #0a84ff;
  --border: rgba(255,255,255,0.12);
  --shadow: rgba(0,0,0,0.4);
}

* {box-sizing: border-box; margin:0; padding:0; -webkit-tap-highlight-color: transparent;}
body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; padding-bottom: 120px; }

#feed {display:flex; flex-direction:column; gap:20px;}

/* КАРТОЧКА ПОСТА */
.card {
  background:var(--card-bg); backdrop-filter:blur(30px); border-radius:30px; padding:20px; 
  border:1px solid var(--border); box-shadow:0 10px 30px var(--shadow);
  opacity: 0; transform: translateY(30px);
  transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.card.appeared { opacity: 1; transform: translateY(0); }

/* БАБЛ ССЫЛКИ */
.link-bubble {
  margin-top: 12px;
  background: rgba(27, 110, 243, 0.1);
  border: 1px solid rgba(27, 110, 243, 0.2);
  border-radius: 20px;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  text-decoration: none;
  color: inherit;
  /* Анимация появления бабла чуть позже поста */
  opacity: 0; transform: scale(0.8);
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  transition-delay: 0.2s; 
}
.card.appeared .link-bubble { opacity: 1; transform: scale(1); }

.link-icon {
  width: 32px; height: 32px; background: var(--accent);
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  color: white; font-size: 18px; font-weight: bold;
}
.link-info { flex: 1; overflow: hidden; }
.link-title { font-weight: 700; font-size: 14px; color: var(--accent); }
.link-host { font-size: 12px; opacity: 0.6; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.author {color:var(--accent); font-weight:700; font-size:14px; margin-bottom:8px;}
.text {line-height:1.5; font-size:16px;}
.img {width:calc(100% + 40px); margin: 0 -20px 15px -20px; cursor:pointer; display:block; border-radius: 0;}

.add-btn { position:fixed; bottom:30px; right:24px; width:64px; height:64px; background:var(--accent); color:white; border:none; border-radius:50%; font-size:32px; box-shadow:0 12px 30px rgba(10,132,255,0.4); z-index:100; }

.modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter:blur(15px); z-index:1000; align-items:center; justify-content:center; padding:20px;}
.modal.show {display:flex;}
.modal-content { background:var(--card-bg); border-radius:35px; padding:25px; width:100%; max-width:400px; border:1px solid var(--border); }
textarea {width:100%; border:none; background:transparent; color:var(--text); font-size:18px; outline:none; margin-bottom:15px; resize: none;}
</style>
</head>
<body>

<div id="feed"></div>
<button class="add-btn" onclick="document.getElementById('modal').classList.add('show')">+</button>

<div id="modal" class="modal" onclick="if(event.target==this) this.classList.remove('show')">
  <div class="modal-content">
    <textarea id="txt" rows="4" placeholder="Вставь ссылку сюда..."></textarea>
    <button onclick="send()" style="width:100%; background:var(--accent); color:white; border:none; padding:15px; border-radius:20px; font-weight:700;">Отправить</button>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
const SUPABASE_URL = 'https://xddulhzvzemmrhrsjfhb.supabase.co';
const SUPABASE_KEY = 'sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function extractLink(text) {
    const urlPattern = /(https?:\/\/[^\s]+)/g;
    return text.match(urlPattern);
}

function getLinkCard(url) {
    try {
        const domain = new URL(url).hostname.replace('www.', '');
        const firstLetter = domain.charAt(0).toUpperCase();
        return `
            <a href="${url}" target="_blank" class="link-bubble">
                <div class="link-icon">${firstLetter}</div>
                <div class="link-info">
                    <div class="link-title">Перейти на ресурс</div>
                    <div class="link-host">${domain}</div>
                </div>
                <div style="color:var(--accent)">→</div>
            </a>
        `;
    } catch(e) { return ''; }
}

async function load() {
    const { data } = await db.from('posts').select('*').order('created_at', { ascending: false });
    const feed = document.getElementById('feed');
    feed.innerHTML = '';

    data.forEach((post, index) => {
        const card = document.createElement('div');
        card.className = 'card';
        
        const links = extractLink(post.content);
        const cleanText = post.content.replace(/(https?:\/\/[^\s]+)/g, '').trim();
        let linkHtml = links ? getLinkCard(links[0]) : '';

        card.innerHTML = `
            <div class="author">@${post.username}</div>
            ${post.image_url ? `<img src="${post.image_url}" class="img">` : ''}
            <div class="text">${cleanText || (links ? 'Поделился ссылкой:' : '')}</div>
            ${linkHtml}
        `;

        feed.appendChild(card);
        setTimeout(() => card.classList.add('appeared'), index * 100);
    });
}

async function send() {
    const txt = document.getElementById('txt').value;
    const user = tg.initDataUnsafe?.user?.username || 'Guest';
    await db.from('posts').insert([{ content: txt, username: user, user_id: '123' }]);
    document.getElementById('modal').classList.remove('show');
    load();
}

load();
</script>
</body>
</html>
