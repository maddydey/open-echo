<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenEcho Secure TG</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
:root {
  --bg: #000;
  --card-bg: rgba(28,28,30,0.85);
  --accent: #0a84ff;
  --text-main: #fff;
  --text-dim: #8e8e93;
  --radius: 24px;
  --card-shadow: 0 8px 30px rgba(0,0,0,0.3);
}
body {
  background: var(--bg);
  color: var(--text-main);
  font-family: -apple-system,system-ui,sans-serif;
  margin:0; padding:20px; overflow-x:hidden;
  -webkit-font-smoothing: antialiased;
  transition: background 0.3s, color 0.3s;
}
h2 { font-weight:800; font-size:28px; margin-bottom:25px; letter-spacing:-1.5px; }
#feed { display:flex; flex-direction:column; gap:14px; }

.echo-card {
  background: var(--card-bg);
  border-radius: var(--radius);
  border:1px solid rgba(255,255,255,0.1);
  overflow:hidden;
  opacity:0;
  transform: translateY(30px) scale(0.95);
  transition: all 0.35s cubic-bezier(0.175,0.885,0.32,1.275);
  word-wrap: break-word;
  box-shadow: var(--card-shadow);
}
.echo-card.visible { opacity:1; transform: translateY(0) scale(1);}
.echo-card:hover { transform: translateY(-2px) scale(1.01); transition: all 0.25s ease-out; }
.card-content { padding:16px; }
.author { color: var(--accent); font-weight:700; margin-bottom:6px; font-size:14px; }
.reply-box { background: rgba(255,255,255,0.05); border-left:3px solid var(--accent); padding:8px 12px; border-radius:12px; margin-bottom:8px; font-size:13px; }
.reply-author { font-weight:700; color: var(--accent); margin-bottom:2px; }
.reply-text { color: var(--text-dim); font-size:13px; }
.post-img { width:100%; display:block; cursor:pointer; border-radius: var(--radius); margin-bottom:8px; }

.link-card {
  display:flex; align-items:center; gap:10px;
  background: rgba(255,255,255,0.05); padding:8px 12px;
  border-radius:12px; margin-top:8px; cursor:pointer;
  opacity:0;
  transform: translateY(20px);
  transition: all 0.35s cubic-bezier(0.175,0.885,0.32,1.275);
}
.link-card.show { opacity:1; transform: translateY(0);}
.link-card:hover { background: rgba(255,255,255,0.15);}
.link-card img { width:24px; height:24px; border-radius:4px;}
.link-card .link-text { color: var(--accent); font-size:14px; font-weight:600; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }

.btn-add {
  position: fixed; bottom:30px; right:20px; width:60px; height:60px;
  border-radius:50%; background: var(--accent); color:white;
  font-size:32px; border:none; display:flex; align-items:center; justify-content:center;
  box-shadow:0 12px 28px rgba(10,132,255,0.35); z-index:100;
  transition: transform 0.2s cubic-bezier(0.34,1.56,0.64,1);
}
.btn-add:active { transform: scale(0.85) rotate(12deg); }

#themeSwitch {
  position: fixed; bottom: 30px; left: 20px; background: var(--accent);
  color: #fff; border:none; padding:10px 16px; border-radius:18px;
  font-weight:700; cursor:pointer; z-index:100;
}

#modal,#imageOverlay {
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); display:flex;
  justify-content:center; align-items:center; padding:20px; box-sizing:border-box;
  z-index:1000;
}
.modal-window,.image-window {
  background:#1c1c1e; border-radius: var(--radius);
  width:100%; max-width:400px; padding:20px; border:1px solid rgba(255,255,255,0.15);
  opacity:0; transform: scale(0.85) translateY(30px);
  transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
.show-win { opacity:1 !important; transform: scale(1) translateY(0) !important; }

textarea { width:100%; background:transparent; border:none; color:white; font-size:17px; resize:none; outline:none; }
#mediaPreview img { border-radius:12px; object-fit:cover; }
.loader { width:20px;height:20px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* –ë–µ–ª–∞—è —Ç–µ–º–∞ */
body.light {
  --bg:#f2f2f2;
  --card-bg:#fff;
  --text-main:#111;
  --text-dim:#555;
  --accent:#007aff;
  --card-shadow: 0 8px 30px rgba(0,0,0,0.1);
}
body.light .echo-card:hover { transform: translateY(-2px) scale(1.01); }
body.light textarea, body.light input { color:#111; background:#fff; border:1px solid #ccc; }
</style>
</head>
<body>

<h2>OpenEcho Secure</h2>
<div id="feed"></div>
<button class="btn-add" onclick="openModal()">+</button>
<button id="themeSwitch" onclick="switchTheme()">‚òÄÔ∏è/üåô</button>

<div id="modal" onclick="if(event.target==this) closeModal()">
  <div class="modal-window" id="modalWin">
    <div id="replyPreview" style="display:none" class="reply-box">
      <div class="reply-author" id="replyAuthorName"></div>
      <div class="reply-text" id="replyTextContent"></div>
    </div>
    <textarea id="postText" rows="4" placeholder="–ù–∞–ø–∏—à–∏ —ç—Ö–æ..."></textarea>
    <div id="mediaPreview" style="display:none;margin-bottom:10px;width:60px;height:60px;position:relative;">
      <img id="previewImg" style="width:100%;height:100%;">
      <div onclick="clearMedia()" style="position:absolute;top:-5px;right:-5px;background:red;color:white;border-radius:50%;width:18px;height:18px;text-align:center;font-size:12px;">‚úï</div>
    </div>
    <input type="text" id="targetUser" style="width:100%;border-radius:12px;padding:10px;margin-bottom:12px;" placeholder="–ü—Ä–∏–≤–∞—Ç–Ω–æ –¥–ª—è @username">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <button onclick="document.getElementById('fileInput').click()" style="background:none;border:none;color:var(--accent);font-weight:600;">üñº –§–æ—Ç–æ</button>
      <input type="file" id="fileInput" hidden onchange="updatePreview()">
      <button id="submitBtn" onclick="sendPost()" style="background:var(--accent);color:white;border:none;padding:10px 20px;border-radius:18px;font-weight:700;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<div id="imageOverlay" onclick="closeFullImage()">
  <div class="image-window" id="imgWin">
    <img id="fullImage" src="">
    <div style="text-align:center;color:white;margin-top:15px;font-weight:600;opacity:0.7;">–ó–∞–∫—Ä—ã—Ç—å ‚úï</div>
  </div>
</div>

<script>
const tg=window.Telegram.WebApp; tg.expand();
const SUPABASE_URL='https://xddulhzvzemmrhrsjfhb.supabase.co';
const SUPABASE_KEY='sb_publishable_2FIKYuEHEQrYseRnwY58Qg__UIFN59j';
const supabaseClient = supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUserId=null,myUsername=null,currentReplyId=null,lastCount=0;
let SECRET_KEY='test_key';

tg.ready.then(()=>{
  currentUserId=tg.initDataUnsafe?.user?.id?.toString()||'guest';
  myUsername=tg.initDataUnsafe?.user?.username||'Guest';
  SECRET_KEY='key_'+currentUserId;
  loadEchos(true);
  supabaseClient.channel('any').on('postgres_changes',{event:'*',schema:'public',table:'posts'},()=>loadEchos(false)).subscribe();
});

function encrypt(text){return CryptoJS.AES.encrypt(text,SECRET_KEY).toString();}
function decrypt(cipher){try{return CryptoJS.AES.decrypt(cipher,SECRET_KEY).toString(CryptoJS.enc.Utf8)}catch(e){return '–û—à–∏–±–∫–∞';}}

function escapeHTML(str){return str.replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' })[c]);}

function renderLinks(text){
  const urlRegex=/(https?:\/\/[^\s]+)/g;
  const container=document.createElement('div');
  text.split(urlRegex).forEach((part,index)=>{
    if(urlRegex.test(part)){
      const card=document.createElement('div'); 
      card.className='link-card';
      const urlObj = new URL(part);
      const domain = urlObj.hostname;
      card.innerHTML=`<img src="https://www.google.com/s2/favicons?domain=${domain}"><div class="link-text">${domain}</div>`;
      card.onclick=()=>window.open(part,'_blank');
      container.appendChild(card);
      setTimeout(()=>card.classList.add('show'), index*100);
    }else{
      const span=document.createElement('span'); 
      span.textContent=part; 
      container.appendChild(span);
    }
  });
  return container;
}

async function loadEchos(isInitial=false){
  const { data }=await supabaseClient.from('posts').select('*').order('created_at',{ascending:false});
  if(!data) return;
  const postMap=Object.fromEntries(data.map(p=>[p.id,p]));

  if(!isInitial && data.length>lastCount){
    const newPost=data[0]; const decrypted=decrypt(newPost.content);
    const hasMention=myUsername && new RegExp(`@${myUsername}\\b`,'i').test(decrypted)||newPost.target_username===myUsername;
    if(hasMention && newPost.user_id!==currentUserId){ tg.HapticFeedback.notificationOccurred('success'); tg.showAlert(`üîî –í–∞—Å —É–ø–æ–º—è–Ω—É–ª @${newPost.username}!`);}
  }
  lastCount=data.length;
  const feed=document.getElementById('feed'); feed.innerHTML='';
  data.forEach((post,index)=>{
    const isMy=post.user_id===currentUserId;
    const isForMe=post.target_username && myUsername===post.target_username;
    if(!post.target_username||isMy||isForMe){
      const card=document.createElement('div'); card.className='echo-card';
      let replyBox='';
      if(post.parent_id){const parent=postMap[post.parent_id]; if(parent){replyBox=`<div class="reply-box"><div class="reply-author">@${escapeHTML(parent.username)}</div><div class="reply-text">${escapeHTML(decrypt(parent.content))||'üñº –§–æ—Ç–æ'}</div></div>`;}}
      const decryptedContent=decrypt(post.content);
      const contentDiv=document.createElement('div');
      contentDiv.appendChild(renderLinks(decryptedContent));
      card.innerHTML=`${post.image_url?`<img loading="lazy" src="${post.image_url}" class="post-img" onclick="openFullImage('${post.image_url}')">`:''}
        <div class="card-content">
          ${replyBox}
          <div class="author">@${escapeHTML(post.username)}${post.target_username?' üîí':''}</div>
        </div>`;
      card.querySelector('.card-content').appendChild(contentDiv);
      const actions=document.createElement('div'); actions.style='display:flex; gap:12px; margin-top:10px;';
      const replyBtn=document.createElement('span'); replyBtn.style='color:var(--accent); font-size:13px; font-weight:600; cursor:pointer;'; replyBtn.textContent='–û—Ç–≤–µ—Ç–∏—Ç—å';
      replyBtn.onclick=()=>setupReply(post.id,post.username,decryptedContent.substring(0,40));
      actions.appendChild(replyBtn);
      if(isMy){ const delBtn=document.createElement('span'); delBtn.style='color:#ff453a; font-size:13px; font-weight:600; cursor:pointer; margin-left:8px'; delBtn.textContent='–£–¥–∞–ª–∏—Ç—å'; delBtn.onclick=()=>deleteEcho(post.id); actions.appendChild(delBtn);}
      card.querySelector('.card-content').appendChild(actions);
      feed.appendChild(card); setTimeout(()=>card.classList.add('visible'),index*50);
    }
  });
}

// –ú–æ–¥–∞–ª–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞
function setupReply(id,user,text){ currentReplyId=id; document.getElementById('replyAuthorName').textContent=`@${user}`; document.getElementById('replyTextContent').textContent=text+'...'; document.getElementById('replyPreview').style.display='block'; openModal(); }
function openModal(){ document.getElementById('modal').style.display='flex'; setTimeout(()=>document.getElementById('modalWin').classList.add('show-win'),10);}
function closeModal(){ document.getElementById('modalWin').classList.remove('show-win'); setTimeout(()=>{ document.getElementById('modal').style.display='none'; document.getElementById('postText').value=''; document.getElementById('replyPreview').style.display='none'; document.getElementById('fileInput').value=''; currentReplyId=null; },300);}
function openFullImage(url){ document.getElementById('fullImage').src=url; document.getElementById('imageOverlay').style.display='flex'; setTimeout(()=>document.getElementById('imgWin').classList.add('show-win'),10);}
function closeFullImage(){ document.getElementById('imgWin').classList.remove('show-win'); setTimeout(()=>document.getElementById('imageOverlay').style.display='none',300);}
function updatePreview(){ const file=document.getElementById('fileInput').files[0]; if(file){ const reader=new FileReader(); reader.onload=e=>{ document.getElementById('previewImg').src=e.target.result; document.getElementById('mediaPreview').style.display='block'; }; reader.readAsDataURL(file);}}
async function deleteEcho(id){ if(confirm("–£–¥–∞–ª–∏—Ç—å?")){ await supabaseClient.from('posts').delete().eq('id',id); loadEchos(); }}
async function sendPost(){ const btn=document.getElementById('submitBtn'); const text=document.getElementById('postText').value.trim(); const target=document.getElementById('targetUser').value.replace('@','').trim(); const file=document.getElementById('fileInput').files[0]; if(!text&&!file)return; btn.disabled=true; btn.innerHTML='<div class="loader" style="margin:auto"></div>'; let imageUrl=null; if(file){ const name=`${Date.now()}.jpg`; const { data }=await supabaseClient.storage.from('images').upload(name,file); if(data)imageUrl=supabaseClient.storage.from('images').getPublicUrl(name).data.publicUrl;} await supabaseClient.from('posts').insert([{username:myUsername,content:encrypt(text),user_id:currentUserId,image_url:imageUrl,target_username:target||null,parent_id:currentReplyId}]); btn.disabled=false; btn.innerText='–û—Ç–ø—Ä–∞–≤–∏—Ç—å'; closeModal(); loadEchos(); }
function switchTheme(){ document.body.classList.toggle('light'); }
</script>
</body>
</html>
